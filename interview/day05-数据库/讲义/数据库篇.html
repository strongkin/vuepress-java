<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/good.png"><title>数据库篇 | strongking</title><meta name="description" content="strongking博客">
    <link rel="modulepreload" href="/vuepress-java/assets/app.8ebbe26f.js"><link rel="modulepreload" href="/vuepress-java/assets/数据库篇.html.420b15c8.js"><link rel="modulepreload" href="/vuepress-java/assets/数据库篇.html.2faba054.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.58c13695.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.0ef9893a.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.d2a40853.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.7e230503.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.89f2a13b.js"><link rel="prefetch" href="/vuepress-java/assets/Git课程讲义.html.879a5ecc.js"><link rel="prefetch" href="/vuepress-java/assets/Redis基础课程讲义.html.f8cf3fff.js"><link rel="prefetch" href="/vuepress-java/assets/基础篇讲义.html.028c762c.js"><link rel="prefetch" href="/vuepress-java/assets/并发篇讲义.html.d9e712e0.js"><link rel="prefetch" href="/vuepress-java/assets/虚拟机篇讲义.html.373ec939.js"><link rel="prefetch" href="/vuepress-java/assets/框架篇讲义.html.17209f9f.js"><link rel="prefetch" href="/vuepress-java/assets/缓存篇讲义.html.9cf7e368.js"><link rel="prefetch" href="/vuepress-java/assets/分布式讲义.html.46f4e374.js"><link rel="prefetch" href="/vuepress-java/assets/EADME.html.5cde76f7.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day01.html.60edf774.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day02.html.498d5ffb.js"><link rel="prefetch" href="/vuepress-java/assets/Vmware虚拟机问题解决方案.html.5f6f36af.js"><link rel="prefetch" href="/vuepress-java/assets/mysql基础.html.f6ee5789.js"><link rel="prefetch" href="/vuepress-java/assets/mysql高级.html.e0e86232.js"><link rel="prefetch" href="/vuepress-java/assets/JDBC.html.587e6170.js"><link rel="prefetch" href="/vuepress-java/assets/Mybatis.html.6eaa3150.js"><link rel="prefetch" href="/vuepress-java/assets/JavaScript.html.72e632c8.js"><link rel="prefetch" href="/vuepress-java/assets/HTML_CSS.html.1acf784d.js"><link rel="prefetch" href="/vuepress-java/assets/HTTP_Tomcat_Servlet.html.ff09d6a5.js"><link rel="prefetch" href="/vuepress-java/assets/Request_Response.html.ce8099d4.js"><link rel="prefetch" href="/vuepress-java/assets/JSP.html.2e5e7f75.js"><link rel="prefetch" href="/vuepress-java/assets/Filter_Listener_Ajax.html.51ea1ed8.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day01.html.34dc44b9.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day02.html.e4378770.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day03.html.eb870fc0.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day01.html.a39cfbd7.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day02.html.a560b5b2.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day03.html.aab72058.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day04.html.95344022.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第五天.html.bf4c2590.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第六天.html.4a07be12.js"><link rel="prefetch" href="/vuepress-java/assets/day02-分类和static.html.d516863f.js"><link rel="prefetch" href="/vuepress-java/assets/day03-继承.html.86897a52.js"><link rel="prefetch" href="/vuepress-java/assets/day04-接口和内部类.html.c2736fc5.js"><link rel="prefetch" href="/vuepress-java/assets/day05-常用API01.html.6ecedb9d.js"><link rel="prefetch" href="/vuepress-java/assets/day06-常用API02.html.2ddc942a.js"><link rel="prefetch" href="/vuepress-java/assets/day10IO流01.html.f4d87ac3.js"><link rel="prefetch" href="/vuepress-java/assets/day11IO流02.html.3b6d400d.js"><link rel="prefetch" href="/vuepress-java/assets/day07集合01.html.a3ee5f56.js"><link rel="prefetch" href="/vuepress-java/assets/day08集合02.html.b5d501ee.js"><link rel="prefetch" href="/vuepress-java/assets/day09集合03.html.08d43cf0.js"><link rel="prefetch" href="/vuepress-java/assets/day12-多线程01.html.25ea7383.js"><link rel="prefetch" href="/vuepress-java/assets/day12 多线程02.html.4b225d57.js"><link rel="prefetch" href="/vuepress-java/assets/day14-网络编程.html.b217db0f.js"><link rel="prefetch" href="/vuepress-java/assets/day16-基础加强01.html.abf7fad0.js"><link rel="prefetch" href="/vuepress-java/assets/day18-基础加强03.html.9615e037.js"><link rel="prefetch" href="/vuepress-java/assets/day07 面向对象.html.e99b9ad2.js"><link rel="prefetch" href="/vuepress-java/assets/day17-基础加强02.html.4806f20a.js"><link rel="prefetch" href="/vuepress-java/assets/day08 常用API.html.25bcd08c.js"><link rel="prefetch" href="/vuepress-java/assets/day09 ArrayList_学生管理系统.html.60f09897.js"><link rel="prefetch" href="/vuepress-java/assets/day01Git.html.47aa810c.js"><link rel="prefetch" href="/vuepress-java/assets/day01-java基础语法.html.4bb04028.js"><link rel="prefetch" href="/vuepress-java/assets/day02-Java基础语法.html.a0e54849.js"><link rel="prefetch" href="/vuepress-java/assets/day03 switch_循环语句.html.fc7ce87f.js"><link rel="prefetch" href="/vuepress-java/assets/day04 IDEA_数组.html.bdcb893b.js"><link rel="prefetch" href="/vuepress-java/assets/day05 方法.html.ced2a258.js"><link rel="prefetch" href="/vuepress-java/assets/day06 Debug_基础练习.html.bbb54b26.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第一天.html.9af90a81.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第二天.html.0f1f6ac5.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第三天.html.7a80cad2.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第一天.html.807d7335.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第二天.html.deff038b.js"><link rel="prefetch" href="/vuepress-java/assets/SpringBoot笔记.html.41b58db7.js"><link rel="prefetch" href="/vuepress-java/assets/MyBatisPlus笔记.html.224f3763.js"><link rel="prefetch" href="/vuepress-java/assets/Maven进阶笔记.html.67f9d23c.js"><link rel="prefetch" href="/vuepress-java/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.4bfc4348.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.26b8cc22.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.ce08971f.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.3a56dae6.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.f1fe6117.js"><link rel="prefetch" href="/vuepress-java/assets/Git课程讲义.html.61bc3587.js"><link rel="prefetch" href="/vuepress-java/assets/Redis基础课程讲义.html.5e451c6c.js"><link rel="prefetch" href="/vuepress-java/assets/基础篇讲义.html.d9332df1.js"><link rel="prefetch" href="/vuepress-java/assets/并发篇讲义.html.034488d9.js"><link rel="prefetch" href="/vuepress-java/assets/虚拟机篇讲义.html.27ad2f73.js"><link rel="prefetch" href="/vuepress-java/assets/框架篇讲义.html.89d087e0.js"><link rel="prefetch" href="/vuepress-java/assets/缓存篇讲义.html.6f6afe40.js"><link rel="prefetch" href="/vuepress-java/assets/分布式讲义.html.cc4c09cd.js"><link rel="prefetch" href="/vuepress-java/assets/EADME.html.00d71550.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day01.html.72322ab0.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day02.html.68e81814.js"><link rel="prefetch" href="/vuepress-java/assets/Vmware虚拟机问题解决方案.html.cc1ed138.js"><link rel="prefetch" href="/vuepress-java/assets/mysql基础.html.52fff1b0.js"><link rel="prefetch" href="/vuepress-java/assets/mysql高级.html.a17b733a.js"><link rel="prefetch" href="/vuepress-java/assets/JDBC.html.1dcd4135.js"><link rel="prefetch" href="/vuepress-java/assets/Mybatis.html.5dd719e3.js"><link rel="prefetch" href="/vuepress-java/assets/JavaScript.html.40f3c6dc.js"><link rel="prefetch" href="/vuepress-java/assets/HTML_CSS.html.ca724664.js"><link rel="prefetch" href="/vuepress-java/assets/HTTP_Tomcat_Servlet.html.05ecd829.js"><link rel="prefetch" href="/vuepress-java/assets/Request_Response.html.92f0727b.js"><link rel="prefetch" href="/vuepress-java/assets/JSP.html.1e3e7af6.js"><link rel="prefetch" href="/vuepress-java/assets/Filter_Listener_Ajax.html.2870e474.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day01.html.6eaa6ed9.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day02.html.bdca4795.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day03.html.28c6ce34.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day01.html.a0830aef.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day02.html.16bfa215.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day03.html.165bdb70.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day04.html.35fd44e2.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第五天.html.5b86e2d0.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第六天.html.f72f49ad.js"><link rel="prefetch" href="/vuepress-java/assets/day02-分类和static.html.8f9cdf0f.js"><link rel="prefetch" href="/vuepress-java/assets/day03-继承.html.89fc4c57.js"><link rel="prefetch" href="/vuepress-java/assets/day04-接口和内部类.html.c394148b.js"><link rel="prefetch" href="/vuepress-java/assets/day05-常用API01.html.dfcae0f4.js"><link rel="prefetch" href="/vuepress-java/assets/day06-常用API02.html.0515d2e6.js"><link rel="prefetch" href="/vuepress-java/assets/day10IO流01.html.d5fe6782.js"><link rel="prefetch" href="/vuepress-java/assets/day11IO流02.html.1db93100.js"><link rel="prefetch" href="/vuepress-java/assets/day07集合01.html.d52599ba.js"><link rel="prefetch" href="/vuepress-java/assets/day08集合02.html.9b1d709c.js"><link rel="prefetch" href="/vuepress-java/assets/day09集合03.html.cae8dcf2.js"><link rel="prefetch" href="/vuepress-java/assets/day12-多线程01.html.5040fa3a.js"><link rel="prefetch" href="/vuepress-java/assets/day12 多线程02.html.b5d23137.js"><link rel="prefetch" href="/vuepress-java/assets/day14-网络编程.html.5c080964.js"><link rel="prefetch" href="/vuepress-java/assets/day16-基础加强01.html.7cd8c347.js"><link rel="prefetch" href="/vuepress-java/assets/day18-基础加强03.html.51143094.js"><link rel="prefetch" href="/vuepress-java/assets/day07 面向对象.html.96e67866.js"><link rel="prefetch" href="/vuepress-java/assets/day17-基础加强02.html.ed78513f.js"><link rel="prefetch" href="/vuepress-java/assets/day08 常用API.html.8ee5483e.js"><link rel="prefetch" href="/vuepress-java/assets/day09 ArrayList_学生管理系统.html.f2f68003.js"><link rel="prefetch" href="/vuepress-java/assets/day01Git.html.d93185ef.js"><link rel="prefetch" href="/vuepress-java/assets/day01-java基础语法.html.a0b41e16.js"><link rel="prefetch" href="/vuepress-java/assets/day02-Java基础语法.html.ce56f294.js"><link rel="prefetch" href="/vuepress-java/assets/day03 switch_循环语句.html.9200bf2f.js"><link rel="prefetch" href="/vuepress-java/assets/day04 IDEA_数组.html.96ca1b72.js"><link rel="prefetch" href="/vuepress-java/assets/day05 方法.html.e03cfae4.js"><link rel="prefetch" href="/vuepress-java/assets/day06 Debug_基础练习.html.763a757f.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第一天.html.fb88021f.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第二天.html.339571af.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第三天.html.12d93add.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第一天.html.1c1187e4.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第二天.html.415101a9.js"><link rel="prefetch" href="/vuepress-java/assets/SpringBoot笔记.html.3ab84f49.js"><link rel="prefetch" href="/vuepress-java/assets/MyBatisPlus笔记.html.a3febf61.js"><link rel="prefetch" href="/vuepress-java/assets/Maven进阶笔记.html.2b90704e.js"><link rel="prefetch" href="/vuepress-java/assets/404.html.35e6889c.js">
    <link rel="stylesheet" href="/vuepress-java/assets/style.5149f99d.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vuepress-java/" class=""><img class="logo" src="/vuepress-java/images/logut.png" alt="strongking"><span class="site-name can-hide">strongking</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/vuepress-java/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/java/" class="" aria-label="java"><!--[--><!--]--> java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/interview/" class="router-link-active" aria-label="java面试"><!--[--><!--]--> java面试 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/gitredis/" class="" aria-label="GitRedis"><!--[--><!--]--> GitRedis <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/vuepress-java/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/java/" class="" aria-label="java"><!--[--><!--]--> java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/interview/" class="router-link-active" aria-label="java面试"><!--[--><!--]--> java面试 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/gitredis/" class="" aria-label="GitRedis"><!--[--><!--]--> GitRedis <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">java面试部分 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vuepress-java/interview/day01-基础篇/讲义/基础篇讲义.md" class="sidebar-item" aria-label="基础篇讲义"><!--[--><!--]--> 基础篇讲义 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/interview/day02-并发篇/讲义/并发篇讲义.md" class="sidebar-item" aria-label="并发篇讲义"><!--[--><!--]--> 并发篇讲义 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/interview/day03-虚拟机/讲义/虚拟机篇讲义.md" class="sidebar-item" aria-label="虚拟机篇讲义"><!--[--><!--]--> 虚拟机篇讲义 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/interview/day04-框架篇/讲义/框架篇讲义.md" class="sidebar-item" aria-label="框架篇讲义"><!--[--><!--]--> 框架篇讲义 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/interview/day05-数据库/讲义/数据库篇.md" class="sidebar-item active" aria-label="数据库篇"><!--[--><!--]--> 数据库篇 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/interview/day06-缓存篇/讲义/缓存篇讲义.md" class="sidebar-item" aria-label="缓存篇讲义"><!--[--><!--]--> 缓存篇讲义 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/interview/day07-分布式/讲义/分布式讲义.md" class="sidebar-item" aria-label="分布式讲义"><!--[--><!--]--> 分布式讲义 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="数据库篇" tabindex="-1"><a class="header-anchor" href="#数据库篇" aria-hidden="true">#</a> 数据库篇</h1><h2 id="_1-隔离级别" tabindex="-1"><a class="header-anchor" href="#_1-隔离级别" aria-hidden="true">#</a> 1. 隔离级别</h2><p><strong>要求</strong></p><ul><li>掌握四种隔离级别与相关的错误现象</li></ul><p><strong>未提交读</strong></p><ul><li><p>读到其它事务未提交的数据（最新的版本）</p></li><li><p>错误现象：有脏读、不可重复读、幻读现象</p></li></ul><p><strong>脏读现象</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level read uncommitted;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /<em>两个账户都为 1000</em>/</td><td></td></tr><tr><td></td><td>start transaction;</td></tr><tr><td></td><td>update account set balance = 2000 where accountNo=1;</td></tr><tr><td>select * from account; /<em>1号账户2000, 2号账户1000</em>/</td><td></td></tr></tbody></table><ul><li>tx2 未提交的情况下，tx1 仍然读取到了它的更改</li></ul><p><strong>提交读（RC）</strong></p><ul><li><p>读到其它事务已提交的数据（最新已提交的版本）</p></li><li><p>错误现象：有不可重复读、幻读现象</p></li><li><p>使用场景：希望看到最新的有效值</p></li></ul><p><strong>不可重复度现象</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level read committed;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /<em>两个账户都为 1000</em>/</td><td></td></tr><tr><td></td><td>update account set balance = 2000 where accountNo=1;</td></tr><tr><td>select * from account; /<em>1号账户2000, 2号账户1000</em>/</td><td></td></tr></tbody></table><ul><li>tx1 在同一事务内，两次读取的结果不一致，当然，此时 tx2 的事务已提交</li></ul><p><strong>可重复读（RR）</strong></p><ul><li><p>在事务范围内，多次读能够保证一致性（快照建立时最新已提交版本）</p></li><li><p>错误现象：有幻读现象，可以用加锁避免</p></li><li><p>使用场景：事务内要求更强的一致性，但看到的未必是最新的有效值</p></li></ul><p><strong>幻读现象</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level repeatable read;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /<em>存在 1,2 两个账户</em>/</td><td></td></tr><tr><td></td><td>insert into account values(3, 1000);</td></tr><tr><td>select * from account; /<em>发现还是只有 1,2 两个账户</em>/</td><td></td></tr><tr><td>insert into account values(3, 5000); /* ERROR 1062 (23000): Duplicate entry &#39;3&#39; for key &#39;PRIMARY&#39; */</td><td></td></tr></tbody></table><ul><li>tx1 查询时并没有发现 3 号账户，执行插入时却发现主键冲突异常，就好像出现了幻觉一样</li></ul><p><strong>加锁避免幻读</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level repeatable read;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /<em>存在 1,2 两个账户</em>/</td><td></td></tr><tr><td>select * from account where accountNo=3 for update;</td><td></td></tr><tr><td></td><td>insert into account values(3, 1000); /* 阻塞 */</td></tr><tr><td>insert into account values(3, 5000);</td><td></td></tr></tbody></table><ul><li>在 for update 这行语句执行时，虽然此时 3 号账户尚不存在，但 MySQL 在 repeatable read 隔离级别下会用间隙锁，锁住 2 号记录与正无穷大之间的间隙</li><li>此时 tx2 想插入 3 号记录就不行了，被间隙锁挡住了</li></ul><p><strong>串行读</strong></p><ul><li><p>在事务范围内，仅有读读可以并发，读写或写写会阻塞其它事务，用这种办法保证更强的一致性</p></li><li><p>错误现象：无</p></li></ul><p><strong>串行读避免幻读</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level serializable;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /* 存在 1,2 两个账户 */</td><td></td></tr><tr><td></td><td>insert into account values(3, 1000); /* 阻塞 */</td></tr><tr><td>insert into account values(3, 5000);</td><td></td></tr></tbody></table><ul><li>串行读隔离级别下，普通的 select 也会加共享读锁，其它事务的查询可以并发，但增删改就只能阻塞了</li></ul><h2 id="_2-快照读与当前读" tabindex="-1"><a class="header-anchor" href="#_2-快照读与当前读" aria-hidden="true">#</a> 2. 快照读与当前读</h2><p><strong>要求</strong></p><ul><li>理解快照读与当前读</li><li>了解快照产生的时机</li></ul><p><strong>当前读</strong></p><p>即读取最新提交的数据</p><ul><li>select … for update</li><li>select ... lock in share mode</li><li>insert、update、delete，都会按最新提交的数据进行操作</li></ul><p>当前读本质上是基于锁的并发读操作</p><p><strong>快照读</strong></p><p>读取某一个快照建立时（可以理解为某一时间点）的数据，也称为一致性读。快照读主要体现在 select 时，而不同隔离级别下，select 的行为不同</p><ul><li><p>在 Serializable 隔离级别下 - 普通 select 也变成当前读，即加共享读锁</p></li><li><p>在 RC 隔离级别下 - 每次 select 都会建立新的快照</p></li><li><p>在 RR 隔离级别下</p><ul><li>事务启动后，首次 select 会建立快照</li><li>如果事务启动选择了 with consistent snapshot，事务启动时就建立快照</li><li>基于旧数据的修改操作，会重新建立快照</li></ul></li></ul><p>快照读本质上读取的是历史数据（原理是回滚段），属于无锁查询</p><p><strong>RR 下，快照建立时机 - 第一次 select 时</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level repeatable read;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /* 此时建立快照，两个账户为 1000 */</td><td></td></tr><tr><td></td><td>update account set balance = 2000 where accountNo=1;</td></tr><tr><td>select * from account; /* 两个账户仍为 1000 */</td><td></td></tr></tbody></table><ul><li>快照一旦建立，以后的查询都基于此快照，因此 tx1 中第二次 select 仍然得到 1 号账户余额为 1000</li></ul><p>如果 tx2 的 update 先执行</p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level repeatable read;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td></td><td>update account set balance = 2000 where accountNo=1;</td></tr><tr><td>select * from account; /* 此时建立快照，1号余额已经为2000 */</td><td></td></tr></tbody></table><p><strong>RR 下，快照建立时机 - 事务启动时</strong></p><p>如果希望事务启动时就建立快照，可以添加 with consistent snapshot 选项</p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level repeatable read;</td><td></td></tr><tr><td>start transaction with consistent snapshot; /* 此时建立快照，两个账户为 1000 */</td><td></td></tr><tr><td></td><td>update account set balance = 2000 where accountNo=1;</td></tr><tr><td>select * from account; /* 两个账户仍为 1000 */</td><td></td></tr></tbody></table><p><strong>RR 下，快照建立时机 - 修改数据时</strong></p><table><thead><tr><th><strong>tx1</strong></th><th><strong>tx2</strong></th></tr></thead><tbody><tr><td>set session transaction isolation level repeatable read;</td><td></td></tr><tr><td>start transaction;</td><td></td></tr><tr><td>select * from account; /* 此时建立快照，两个账户为 1000 */</td><td></td></tr><tr><td></td><td>update account set balance=balance+1000 where accountNo=1;</td></tr><tr><td>update account set balance=balance+1000 where accountNo=1;</td><td></td></tr><tr><td>select * from account; /* 1号余额为3000 */</td><td></td></tr></tbody></table><ul><li>tx1 内的修改必须重新建立快照，否则，就会发生丢失更新的问题</li></ul><h2 id="_3-innodb-vs-myisam" tabindex="-1"><a class="header-anchor" href="#_3-innodb-vs-myisam" aria-hidden="true">#</a> 3. InnoDB vs MyISAM</h2><p><strong>要求</strong></p><ul><li>掌握 InnoDB 与 MyISAM 的主要区别</li><li>尤其注意它们在索引结构上的区别</li></ul><p><strong>InnoDB</strong></p><ul><li><p>索引分为聚簇索引与二级索引</p><ul><li>聚簇索引：主键值作为索引数据，叶子节点还包含了所有字段数据，索引和数据是存储在一起的</li><li>二级索引：除主键外的其它字段建立的索引称为二级索引。被索引的字段值作为索引数据，叶子节点还包含了主键值</li></ul></li><li><p>支持事务</p><ul><li>通过 undo log 支持事务回滚、当前读（多版本查询）</li><li>通过 redo log 实现持久性</li><li>通过两阶段提交实现一致性</li><li>通过当前读、锁实现隔离性</li></ul></li><li><p>支持行锁、间隙锁</p></li><li><p>支持外键</p></li></ul><p><strong>MyISAM</strong></p><ul><li><p>索引只有一种</p><ul><li>被索引字段值作为索引数据，叶子节点还包含了该记录数据页地址，数据和索引是分开存储的</li></ul></li><li><p>不支持事务，没有 undo log 和 redo log</p></li><li><p>仅支持表锁</p></li><li><p>不支持外键</p></li><li><p>会保存表的总行数</p></li></ul><p><strong>InnoDB 索引特点</strong></p><p>聚簇索引：主键值作为索引数据，叶子节点还包含了所有字段数据，索引和数据是存储在一起的</p><p><img src="/vuepress-java/assets/image-20210901155308778.a1bb5e5b.png" alt="image-20210901155308778"></p><ul><li>主键即 7369、7499、7521 等</li></ul><p>二级索引：除主键外的其它字段建立的索引称为二级索引。被索引的字段值作为索引数据，叶子节点还包含了主键值</p><p><img src="/vuepress-java/assets/image-20210901155317460.47050ac1.png" alt="image-20210901155317460"></p><ul><li>上图中 800、950、1100 这些是工资字段的值，根据它们建立了二级索引</li></ul><p><img src="/vuepress-java/assets/image-20210901155327838.cbc04be2.png" alt="image-20210901155327838"></p><ul><li>上图中，如果执行查询 <code>select empno, ename, sal from emp where sal = 800</code>，这时候可以利用二级索引定位到 800 这个工资，同时还能知道主键值 7369</li><li>但 select 字句中还出现了 ename 字段，在二级索引中不存在，因此需要根据主键值 7369 查询聚簇索引来获取 ename 的信息，这个过程俗称<strong>回表</strong></li></ul><p><strong>MyISAM 索引特点</strong></p><p>被索引字段值作为索引数据，叶子节点还包含了该记录数据页地址，数据和索引是分开存储的</p><p><img src="/vuepress-java/assets/image-20210901155226621.57bfcc3f.png" alt="image-20210901155226621"></p><h2 id="_4-索引" tabindex="-1"><a class="header-anchor" href="#_4-索引" aria-hidden="true">#</a> 4. 索引</h2><p><strong>要求</strong></p><ul><li>了解常见索引与它们的适用场景，尤其是 B+Tree 索引的特点</li><li>掌握索引用于排序，以及失效情况</li><li>掌握索引用于筛选，以及失效情况</li><li>理解索引条件下推</li><li>理解二级索引覆盖</li></ul><h3 id="索引基础" tabindex="-1"><a class="header-anchor" href="#索引基础" aria-hidden="true">#</a> 索引基础</h3><p><strong>常见索引</strong></p><ul><li><p>哈希索引</p><ul><li>理想时间复杂度为 $O(1)$</li><li>适用场景：适用于等值查询的场景，内存数据的索引</li><li>典型实现：Redis，MySQL 的 memory 引擎</li></ul></li><li><p>平衡二叉树索引</p><ul><li>查询和更新的时间复杂度都是 $O(log_2(n))$</li><li>适用场景：适用于等值查询以及范围查询；适合内存数据的索引，但不适合磁盘数据的索引，可以认为<strong>树的高度决定了磁盘 I/O 的次数</strong>，百万数据树高约为 20</li></ul></li><li><p>BTree 索引</p><ul><li>BTree 其实就是 n 叉树，分叉多意味着节点中的孩子（key）多，树高自然就降低了</li><li>分叉数由页大小和行（包括 key 与 value）大小决定 <ul><li>假设页大小为 16k，每行 40 个字节，那么分叉数就为 16k / 40 ≈ 410</li><li>而分叉为 410，则百万数据树高约为3，仅 3 次 I/O 就能找到所需数据</li></ul></li><li><strong>局部性原理</strong>：每次 I/O 按页为单位读取数据，把多个 <strong>key 相邻</strong>的行放在同一页中（每页就是树上一个节点），能进一步减少 I/O</li></ul></li><li><p>B+ 树索引</p><ul><li>在 BTree 的基础上做了改进，索引上只存储 key，这样能进一步增加分叉数，假设 key 占 13 个字节，那么一页数据分叉数可以到 1260，树高可以进一步下降为 2</li></ul></li></ul><blockquote><p><em><strong>树高计算公式</strong></em></p><ul><li>$log_{10}(N) / log_{10}(M)$ 其中 N 为数据行数，M 为分叉数</li></ul></blockquote><p><strong>BTree vs B+Tree</strong></p><ul><li>无论 BTree 还是 B+Tree，每个叶子节点到根节点距离都相同</li><li>BTree key 及 value 在每个节点上，无论叶子还是非叶子节点</li></ul><img src="/vuepress-java/assets/image-20210901170943656.ca8693ca.png" alt="image-20210901170943656" style="zoom:80%;"><ul><li>B+Tree 普通节点只存 key，叶子节点才存储 key 和 value，因此分叉数可以更多 <ul><li>不过也请注意，普通节点上的 key 有的会与叶子节点的 key 重复</li></ul></li><li>B+Tree 必须到达叶子节点才能找到 value</li><li>B+Tree 叶子节点用链表连接，可以方便范围查询及全表遍历</li></ul><img src="/vuepress-java/assets/image-20210901170954328.c976b9a3.png" alt="image-20210901170954328" style="zoom:80%;"><blockquote><p>注：这两张图都是仅画了 key，未画 value</p></blockquote><p><strong>B+Tree 新增 key</strong></p><p>假设阶数（m）为5</p><ol><li><p>若为空树，那么直接创建一个节点，插入 key 即可，此时这个叶子结点也是根结点。例如，插入 5</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADcAAAAiCAYAAAD7wEFuAAACUElEQVRYhe2YP2gTURzHPydGSq4ngrlc0oKkIaKhkKENAbMYtCBBHRx0cBGsKKhDoQ6SgM1S7BDQSRGSgiCCuNhi0EKE4KBLzBCIIJEqgjG1CmJ7GcwQh2hsIbnU3vnnwn2n4/t77/H98vu+e48nNBqNBj2KLf9awJ+EZc6s6GlzW7WKiWzyb+nQhcTYpba8pjmA82NnDBdjJG5kUx1rPR1Ly5xZYZnrhkK1hDIdRIn5OTZ3uSt/9XkKJeZHifnJlHMALKnLKNcOtPi14zeLrn/LblDrNaILM8yeSBLxhPDePUemnCPiCbXl3ZLM9eJDivGnvF/5SHQuTnFgGICwN8Sdi1cQbXbdxsAAc68+v2GwTyLiCSHa7MyGx0m9fIxbktvyIaePicARFFFGEWXCrr3kKyXckoyjr98wY2BQLEd3DLRE/RSpxQccvtbckPPX93z+QTOW00EK1ZJuXbo7ZxRGXMMsxfMAZMo5ogszLJ68pauThnTuxZcKar0GwIeVZbzbXZp88dPr1tzFr1XckrxuveCPPbj6TdWlS7e5PTuHgObeU+s1Tj9LE3D4OvKHhvZx/10BtV6jUC0x/zbPoORct2a+0oxk/zZRlzbdsRRtdlL7LxBNnwJVZeLoJId3RwA68sd3jeCdGgVR5NH4bRRRplAttcYiuymevbehSAqC0Lmm9cyQyCb/+4vzzSdppg5Otq2Z/oai9QRkenNasTS9OatzvQjTm9OKZddzbu0bhSAImotpjdvo3N/Fps85s8P0sdSCZc6ssMyZFT1t7ju4ANM15+jfCwAAAABJRU5ErkJggg==" alt="image-20210901174939408"></p></li><li><p>插入时，若当前结点 key 的个数小于阶数，则插入结束</p></li><li><p>依次插入 8、10、15，按 key 大小升序</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKwAAAAgCAYAAACPQ5N7AAADy0lEQVR4nO3bQWibdRjH8W/ESMjbyMCkb5qAdKHFZYEc2hCwlwUduFhFdlBhIENbnDiR6TyMFFw9VHeo6MmhpIXBGIge7LCshSrBQwclyyHQutHRFqFd0nZQTFOKPdRD3GslbzqX/JvkHc/nFB6S8Ov7f/J/n/dtYtvd3d1FCIt4otEBhHgU0rDCUqRhhaVIwwpLedKsODg1XO8clmaz2ZBrV/UGj39SVjNtWID3j/cfaBgh9vPNVNK0LiOBsBRpWGEp0rDCUqRhhaXU1LCZ3Cz6UAQ9EeTk2IWH1r+4mURPBNETQcbnUwDki2voX71g1Pc+v1Yq8gGcHLtgWq93PiPjlbco7myV5xuKkMnNNlU+1etb8S7BwxR3tohPXmL0jWFi7VEC184wPp8i1h41rbe5PHyd/ZnswG8sF1aJjw2Q9YUA6AlEufrBp2h2Z01/zEHkS6+UGiD/+e/ki2uEf/yYrC+Ernnqmi/iCxH+7k38viP4HS7jfcbnU0xvLLPw2S1SSzPEJy+xcOrbmo+lqnygdn2r3mHv3F/E73ARa4+i2Z2M9vSRnJuoWJ9cvMm58Cvomocub4ge7xHSK7MsF1ZxO1qUNqvKfHstF1Zhu9CQfLrmIf/RrySPnf3P+yTnJhjt6UOzO4m1R/E7XNy5v9g0+VSvb00jQfchnxGkzeXB7WjZtx52dxivjbb++/h6+qcDOaWpyNfbGSPa2oGeCBIfOc2N14Zq3l2rzWfG7WihzVXKo9mddB/yKcmmKh+oXd+qRwJVurwh8gNpoHR6U3VKU2V8PsXM6l1jJHhv6kuuvqx2fHmcqV7fmnbYWxsrxnB9r7BG4GnvvvXs+l3jtQt/5oyd4YHIPzPt5l/FWmIpzZecm6D/6AkAY2dNLc00JJ+Z9e1N7hXWgNLcub69id/V2jT59lKxvlU37HPPHAZKs05xZ4t3pkcIuzsq1l86/Dw//JGhuLNFJjfL9aV02YF9MDO2PKVVG0t5vmhrB8m5CaB0xTudu132QatHvkr6j54w8qWWZpjeWG7I8fs/VKxv1SOBZneSPHaW+MhpKBY59+p5ejtjABXrrz/bReBiN2gaN/quoGseMrlZ47l42si++72S062qfB9GThG4dgY9EQRg9O3LdHlDDclnprczVrroSQQbfvzMVLu+NpvNvG72E5nBqWH58otoqMu/jHDxxfNldflPl2hKlb6uKQ0rmlKlkUAaVjQl2WGFpcgOKx4L0rCiKVUaCSreh630mxoh6uGR7sMK0axkJBCWIg0rLEUaVliKNKywlL8B+cS7Q4iuTCoAAAAASUVORK5CYII=" alt="image-20210901175021697"></p></li><li><p>插入 16，这时到达了阶数限制，所以要进行分裂</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAAAsCAYAAACTxd8QAAAEr0lEQVR4nO3dQUhbdxwH8G/HHMFnRsoSX4wwVJSZBnJQidRLwy7V2TF62MYKpWy266BjuBVGibCxg2sPkw12GBtRKJXC2A6zTFQYI/SgKKmHQNyKQWUQmxjLssUnrh7cIfPNmvdio//4f9Tv5yT/vIQv759f3u8f33s5trW1tQUikuYZ2QGIjjoWIZFkLEIiyViERJI9a/rI9PQhxiA6ItrbC4bMixAAOjvLFYXo6BkfNxwuXoQAkM2KjkJ09Dgcpg9xTUgkGYuQSDIWIZFke68JdxkIlCMG0dPl6syTb1tyEQLA+ek/9/M0oiPhVvvxkrZnO0okGYuQSDIWIZFkLEIiycpWhLOpONT+NqghL86OXNtz/PpUGGrICzXkxeh8BACQ1jJQv3xZH9+5vRXyAcDZkWuG44edT8948zy0zfXCfP1tmE3FLZXPSvNrlK8g467HRNnXt6N70TbX0TVxA0NvfIFgXQANty9jdD6CYF3AcLzG7sJXsZ8R67uLZG4FXSN9iHl8AICOhgCG3/8ESkWl5fJFl/Nv6vTnvyGtZeD/8SPEPD6oiutQ87V5fPB/9yZqPc2otdn11xmdj2Aym8TCZ/cQWZpB18QNLJz79sD7UlQ+wBrza5YvrWXgH76Esbe+RovbJyzfbmU5Et5/uIhamx3BugCUikoMdfQgPDduOj6xOIVe/xmoigstbh863M2ILseRzK3AaasSOkEi8+2UzK0AGzkp+VTFhfSHvyJ86spjrxOeG8dQRw+UikoE6wKotdlx/+GiZfJZZX7N8kWX4+j1nylrAQJlbEdbHR5959bYXXDaqoqO+52N+nMD1f//fSf6U1naKRH5upuCCFQ3Qg150TV4AWOv9R/4KLjffEactirU2PN5lIpKtDo8QrKJygdYZ36NxFYT+OufNb19vT4VFpZvp7K0o6K0uH1I90UB5FsrUe2UKKPzEcysJPR29L1fBjD8itjW6mlm9fmdWUnk2/mP72LtkQb/8CWcrj8p/MhYtiPhveyyvoh9kMug4Xl30fHYakJ/7sLfKf0TfFvbf2vEtUeaZfKF58Zx8UT+msvtI2BkqYTzlQTmM7K6sYYHuQyA/DppdWMNtfZqy+TbSfb8GglUN+rtvKq40OFu1venSGUpwpdeqAeQ7821zXW8MzkIv7PRdPx0/Un88McstM11zKbiuLMULXizbK/Bqp5TLJMvUN2I8Fz+Qs20lsFk6veCD4/DyGfm4olOPV9kaQaT2aSU/fckZM6vGb9z1/xmk/qHhUhlaUeVikqET11B1+AFQNPQ++pVdDcFAcB0/PUXW9DwaSugKBjruQlVcWE2Fde3hasGsXe/F9KqiMr3Qds5NNy+DDXkBQAMvf2NkFZlP/mMdDcF8188hLzS958RK82vke6mIGKricfmV9Saf6djpjf/nZ7O395i15X1AwGewE1UzK3244VXUTgc+dtbGNxjhmfMEEnGIiSSjEVIJBmLkEgyFiGRZCxCIsn29X/CUu+hQUTmSi7CUu4iRUR7YztKJBmLkEgyFiGRZHuvCYv8mgwRHVzxIjT5PTUiEsf8KgoiOhRcExJJxiIkkoxFSCQZi5BIsn8B0y9ciIFymd4AAAAASUVORK5CYII=" alt="image-20210901175057315"></p></li><li><p><strong>叶子节点分裂规则</strong>：将这个叶子结点分裂成左右两个叶子结点，左叶子结点包含前 m/2 个（2个）记录，右结点包含剩下的记录，将中间的 key 进位到父结点中。<strong>注意</strong>：中间的 key 仍会保留在叶子节点一份</p><p><img src="data:image/png;base64,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" alt="image-20210901175106713"></p></li><li><p>插入 17</p><p><img src="data:image/png;base64,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" alt="image-20210901175333804"></p></li><li><p>插入 18，这时当前结点的 key 个数到达 5，进行分裂</p><p><img src="data:image/png;base64,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" alt="image-20210901175352807"></p></li><li><p>分裂成两个结点，左结点 2 个记录，右结点 3 个记录，key 16 进位到父结点中</p><p><img src="data:image/png;base64,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" alt="image-20210901175413305"></p></li><li><p>插入 19、20、21、22、6、9</p><p><img src="/vuepress-java/assets/image-20210901175440205.7b43374c.png" alt="image-20210901175440205"></p></li><li><p>插入 7，当前结点的 key 个数到达 5，需要分裂</p><p><img src="/vuepress-java/assets/image-20210901175518737-16304901199481.c23907ff.png" alt="image-20210901175518737"></p></li><li><p>分裂后 key 7 进入到父结点中，这时父节点 key 个数也到达 5</p><p><img src="/vuepress-java/assets/image-20210901175544893.96b55ae0.png" alt="image-20210901175544893"></p></li><li><p><strong>非叶子节点分裂规则</strong>：左子结点包含前 (m-1)/2 个 key，将中间的 key 进位到父结点中（<strong>不保留</strong>），右子节点包含剩余的 key</p><p><img src="/vuepress-java/assets/image-20210901175617464.fad6b85c.png" alt="image-20210901175617464"></p></li></ol><p><strong>B+Tree 查询 key</strong></p><p>以查询 15 为例</p><ul><li><p>第一次 I/O</p><p><img src="/vuepress-java/assets/image-20210901175721826.e0f1ac02.png" alt="image-20210901175721826"></p></li><li><p>第二次 I/O</p><!-- ![image-20210901175738876](./img/image-20210901175738876-16304902605912.png) --></li><li><p>第三次 I/O</p><p><img src="/vuepress-java/assets/image-20210901175801859.3075608d.png" alt="image-20210901175801859"></p></li></ul><p><strong>B+Tree 删除叶子节点 key</strong></p><ol><li><p>初始状态</p><p><img src="/vuepress-java/assets/image-20210901175617464.fad6b85c.png" alt="image-20210901180320860"></p></li><li><p><strong>删完有富余</strong>。即删除后结点的key的个数 &gt; m/2 – 1，删除操作结束，例如删除 22</p><p><img src="/vuepress-java/assets/image-20210901180331158.1d81aa1b.png" alt="image-20210901180331158"></p></li><li><p><strong>删完没富余，但兄弟节点有富余</strong>。即兄弟结点 key 有富余（ &gt; m/2 – 1 ），向兄弟结点借一个记录，同时替换父节点，例如删除 15</p><p><img src="/vuepress-java/assets/image-20210901180356515.79ae3028.png" alt="image-20210901180356515"></p></li><li><p><strong>兄弟节点也不富余，合并兄弟叶子节点</strong>。即兄弟节点合并成一个新的叶子结点，并删除父结点中的key，将当前结点指向父结点，例如删除 7</p><p><img src="/vuepress-java/assets/image-20210901180405393.8c2f6eb8.png" alt="image-20210901180405393"></p></li><li><p>也需要删除非叶子节点中的 7，并替换父节点保证区间仍有效</p><p><img src="/vuepress-java/assets/image-20210901180422491.8bcba2b4.png" alt="image-20210901180422491"></p></li><li><p>左右兄弟都不够借，合并</p></li></ol><p><strong>B+Tree 删除非叶子节点 key</strong></p><p>接着上面的操作</p><ol><li><p>非叶子节点 key 的个数 &gt; m/2 – 1，则删除操作结束，否则执行 2</p></li><li><p>若<strong>兄弟结点有富余</strong>，父结点 key 下移，兄弟结点 key 上移，删除结束，否则执行 3</p></li><li><p>若<strong>兄弟节点没富余</strong>，当前结点和兄弟结点及父结点合并成一个新的结点。重复 1</p></li></ol><!-- 
   ![image-20210901180511685](./img/image-20210901180511685.png) --><p><img src="/vuepress-java/assets/image-20210901180516139.6e33c525.png" alt="image-20210901180516139"></p><h3 id="命中索引" tabindex="-1"><a class="header-anchor" href="#命中索引" aria-hidden="true">#</a> 命中索引</h3><blockquote><p><strong>准备数据</strong></p><ol><li><p>修改 MySQL 配置文件，在 [mysqld] 下添加 secure_file_priv= 重启 MySQL 服务器，让选项生效</p></li><li><p>执行 db.sql 内的脚本，建表</p></li><li><p>执行 <code>LOAD DATA INFILE &#39;D:\\big_person.txt&#39; INTO TABLE big_person;</code> 注意实际路径根据情况修改</p><ul><li>测试表 big_person（此表数据量较大，如果与其它表数据一起提供不好管理，故单独提供），数据行数 100 万条，列个数 15 列。为了更快速导入数据，这里采用了 load data infile 命令配合 *.txt 格式数据</li></ul></li></ol></blockquote><p><strong>索引用于排序</strong></p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/* 测试单列索引并不能在多列排序时加速 */</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> first_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>first_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> last_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>last_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">order</span> <span class="token keyword">by</span> last_name<span class="token punctuation">,</span> first_name <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span> 

<span class="token comment">/* 多列排序需要用组合索引 */</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> big_person <span class="token keyword">drop</span> <span class="token keyword">index</span> first_idx<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> big_person <span class="token keyword">drop</span> <span class="token keyword">index</span> last_idx<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> last_first_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>last_name<span class="token punctuation">,</span>first_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 多列排序需要遵循最左前缀原则, 第1个查询可以利用索引，第2,3查询不能利用索引 */</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">order</span> <span class="token keyword">by</span> last_name<span class="token punctuation">,</span> first_name <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">order</span> <span class="token keyword">by</span> first_name<span class="token punctuation">,</span> last_name <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">order</span> <span class="token keyword">by</span> first_name <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span> 

<span class="token comment">/* 多列排序升降序需要一致，查询1可以利用索引，查询2不能利用索引*/</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">order</span> <span class="token keyword">by</span> last_name <span class="token keyword">desc</span><span class="token punctuation">,</span> first_name <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">order</span> <span class="token keyword">by</span> last_name <span class="token keyword">desc</span><span class="token punctuation">,</span> first_name <span class="token keyword">asc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><em><strong>最左前缀原则</strong></em></p><p>若建立组合索引 (a,b,c)，则可以<strong>利用</strong>到索引的排序条件是：</p><ul><li>order by a</li><li>order by a, b</li><li>order by a, b, c</li></ul></blockquote><p><strong>索引用于 where 筛选</strong></p><ul><li>参考 https://dev.mysql.com/doc/refman/8.0/en/multiple-column-indexes.html</li></ul><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/* 模糊查询需要遵循字符串最左前缀原则，查询2可以利用索引，查询1,3不能利用索引 */</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> first_name <span class="token operator">LIKE</span> <span class="token string">&#39;dav%&#39;</span> <span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> last_name <span class="token operator">LIKE</span> <span class="token string">&#39;dav%&#39;</span> <span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> last_name <span class="token operator">LIKE</span> <span class="token string">&#39;%dav&#39;</span> <span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment">/* 组合索引需要遵循最左前缀原则，查询1,2可以利用索引，查询3,4不能利用索引 */</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> province_city_county_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>province<span class="token punctuation">,</span>city<span class="token punctuation">,</span>county<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> city<span class="token operator">=</span><span class="token string">&#39;宜兰县&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span> <span class="token operator">AND</span> city<span class="token operator">=</span><span class="token string">&#39;宜兰县&#39;</span> <span class="token operator">AND</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">&#39;宜兰县&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>

<span class="token comment">/* 函数及计算问题，一旦在字段上应用了计算或函数，都会造成索引失效。查询2可以利用索引，查询1不能利用索引 */</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> birthday_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>birthday<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> ADDDATE<span class="token punctuation">(</span>birthday<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&#39;2005-02-10&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> birthday<span class="token operator">=</span>ADDDATE<span class="token punctuation">(</span><span class="token string">&#39;2005-02-10&#39;</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 隐式类型转换问题
	* 查询1会发生隐式类型转换等价于在phone上应用了函数，造成索引失效
	* 查询2字段与值类型相同不会类型转换，可以利用索引
*/</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> phone_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> phone <span class="token operator">=</span> <span class="token number">13000013934</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> phone <span class="token operator">=</span> <span class="token string">&#39;13000013934&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><em><strong>最左前缀原则（leftmost prefix）</strong></em></p><p>若建立组合索引 (a,b,c)，则可以<strong>利用</strong>到索引的查询条件是：</p><ul><li>where a = ?</li><li>where a = ? and b = ? （注意与条件的先后次序无关，也可以是 where b = ? and a = ?，只要出现即可）</li><li>where a = ? and b = ? and c = ? （注意事项同上）</li></ul><p><strong>不能利用</strong>的例子：</p><ul><li>where b = ?</li><li>where b = ? and c = ?</li><li>where c = ?</li></ul><p>特殊情况：</p><ul><li>where a = ? and c = ?（a = ? 会利用索引，但 c = ? 不能利用索引加速，会触发索引条件下推）</li></ul></blockquote><p><strong>索引条件下推</strong></p><ul><li>参考 https://dev.mysql.com/doc/refman/8.0/en/index-condition-pushdown-optimization.html</li></ul><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/* 查询 1,2,3,4 都能利用索引，但 4 相当于部分利用了索引，会触发索引条件下推 */</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> city<span class="token operator">=</span><span class="token string">&#39;嘉兴市&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> city<span class="token operator">=</span><span class="token string">&#39;嘉兴市&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><em><strong>索引条件下推</strong></em></p><ul><li>MySQL 执行条件判断的时机有两处： <ul><li>服务层（上层，不包括索引实现）</li><li>引擎层（下层，包括了索引实现，可以利用）</li><li>上面查询 4 中有 province 条件能够利用索引，在引擎层执行，但 county 条件仍然要交给服务层处理</li></ul></li><li>在 5.6 之前，服务层需要判断所有记录的 county 条件，性能非常低</li><li>5.6 以后，引擎层会先根据 province 条件过滤，满足条件的记录才在服务层处理 county 条件</li></ul></blockquote><p>我们现在用的是 5.6 以上版本，所以没有体会，可以用下面的语句关闭索引下推优化，再测试一下性能</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> optimizer_switch <span class="token operator">=</span> <span class="token string">&#39;index_condition_pushdown=off&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>二级索引覆盖</strong></p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> city<span class="token operator">=</span><span class="token string">&#39;宜兰县&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span> <span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>province<span class="token punctuation">,</span>city<span class="token punctuation">,</span>county <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> province <span class="token operator">=</span> <span class="token string">&#39;上海&#39;</span> <span class="token operator">AND</span> city<span class="token operator">=</span><span class="token string">&#39;宜兰县&#39;</span> <span class="token operator">AND</span> county<span class="token operator">=</span><span class="token string">&#39;中西区&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>根据查询条件查询 1，2 都会先走二级索引，但是二级索引仅包含了 (province, city, county) 和 id 信息</p><ul><li>查询 1 是 select *，因此还有一些字段二级索引中没有，需要回表（查询聚簇索引）来获取其它字段信息</li><li>查询 2 的 select 中明确指出了需要哪些字段，这些字段在二级索引都有，就避免了回表查询</li></ul><p><strong>其它注意事项</strong></p><ul><li>表连接需要在连接字段上建立索引</li><li>不要迷信网上说法，具体情况具体分析</li></ul><p>例如：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">index</span> first_idx <span class="token keyword">on</span> big_person<span class="token punctuation">(</span>first_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 不会利用索引，因为优化器发现查询记录数太多，还不如直接全表扫描 */</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> first_name <span class="token operator">&gt;</span> <span class="token string">&#39;Jenni&#39;</span><span class="token punctuation">;</span>

<span class="token comment">/* 会利用索引，因为优化器发现查询记录数不太多 */</span>
<span class="token keyword">explain</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> big_person <span class="token keyword">WHERE</span> first_name <span class="token operator">&gt;</span> <span class="token string">&#39;Willia&#39;</span><span class="token punctuation">;</span>

<span class="token comment">/* 同一字段的不同值利用 or 连接，会利用索引 */</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">or</span> id <span class="token operator">=</span> <span class="token number">190839</span><span class="token punctuation">;</span>

<span class="token comment">/* 不同字段利用 or 连接，会利用索引(底层分别用了两个索引) */</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">where</span> first_name <span class="token operator">=</span> <span class="token string">&#39;David&#39;</span> <span class="token operator">or</span> last_name <span class="token operator">=</span> <span class="token string">&#39;Thomas&#39;</span><span class="token punctuation">;</span>

<span class="token comment">/* in 会利用索引 */</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">where</span> first_name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">&#39;Mark&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Kevin&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;David&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">/* not in 不会利用索引的情况 */</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> big_person <span class="token keyword">where</span> first_name <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">&#39;Mark&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Kevin&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;David&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* not in 会利用索引的情况 */</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> id <span class="token keyword">from</span> big_person <span class="token keyword">where</span> first_name <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">&#39;Mark&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Kevin&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;David&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>以上实验基于 5.7.27，其它如 !=、is null、is not null 是否使用索引都会跟版本、实际数据相关，以优化器结果为准</li></ul><h2 id="_5-查询语句执行流程" tabindex="-1"><a class="header-anchor" href="#_5-查询语句执行流程" aria-hidden="true">#</a> 5. 查询语句执行流程</h2><p><strong>要求</strong></p><ul><li>了解查询语句执行流程</li></ul><p><strong>执行 SQL 语句 select * from user where id = 1 时发生了什么</strong></p><p><img src="/vuepress-java/assets/image-20210902082718756.0a56ea92.png" alt="image-20210902082718756"></p><ol><li><p>连接器：负责建立连接、检查权限、连接超时时间由 wait_timeout 控制，默认 8 小时</p></li><li><p>查询缓存：会将 SQL 和查询结果以键值对方式进行缓存，修改操作会以表单位导致缓存失效</p></li><li><p>分析器：词法、语法分析</p></li><li><p>优化器：决定用哪个索引，决定表的连接顺序等</p></li><li><p>执行器：根据存储引擎类型，调用存储引擎接口</p></li><li><p>存储引擎：数据的读写接口，索引、表都在此层实现</p></li></ol><h2 id="_6-undo-log-与-redo-log" tabindex="-1"><a class="header-anchor" href="#_6-undo-log-与-redo-log" aria-hidden="true">#</a> 6. undo log 与 redo log</h2><p><strong>要求</strong></p><ul><li>理解 undo log 的作用</li><li>理解 redo log 的作用</li></ul><p><strong>undo log</strong></p><ul><li>回滚数据，以行为单位，记录数据每次的变更，一行记录有多个版本并存</li><li>多版本并发控制，即快照读（也称为一致性读），让查询操作可以去访问历史版本</li></ul><p><img src="/vuepress-java/assets/image-20210902083051903.b30e6025.png" alt="image-20210902083051903"></p><ol><li>每个事务会按照开始时间，分配一个单调递增的事务编号 trx id</li><li>每次事务的改动都会以行为单位记入回滚日志，包括当时的事务编号，改动的值等</li><li>查询操作，事务编号大于自己的数据是不可见的，事务编号小于等于自己的数据才是可见的 <ul><li>例如图中红色事务看不到 trx id=102 以及 trx id=101 的数据，只有 trx id=99 的数据对它可见</li></ul></li></ol><p><strong>redo log</strong></p><p>redo log 的作用主要是实现 ACID 中的持久性，保证提交的数据不丢失</p><ul><li>它记录了事务提交的变更操作，服务器意外宕机重启时，利用 redo log 进行回放，重新执行已提交的变更操作</li><li>事务提交时，首先将变更写入 redo log，事务就视为成功。至于数据页（表、索引）上的变更，可以放在后面慢慢做 <ul><li>数据页上的变更宕机丢失也没事，因为 redo log 里已经记录了</li><li>数据页在磁盘上位置随机，写入速度慢，redo log 的写入是顺序的速度快</li></ul></li></ul><p>它由两部分组成，内存中的 redo log buffer，磁盘上的 redo log file</p><ul><li>redo log file 由一组文件组成，当写满了会循环覆盖较旧的日志，这意味着不能无限依赖 redo log，更早的数据恢复需要 binlog</li><li>buffer 和 file 两部分组成意味着，写入了文件才真正安全，同步策略由参数 innodb_flush_log_at_trx_commit 控制 <ul><li>0 - 每隔 1s 将日志 write and flush 到磁盘</li><li>1 - 每次事务提交将日志 write and flush（默认值）</li><li>2 - 每次事务提交将日志 write，每隔 1s flush 到磁盘，意味着 write 意味着写入操作系统缓存，如果 MySQL 挂了，而操作系统没挂，那么数据不会丢失</li></ul></li></ul><h2 id="_7-锁" tabindex="-1"><a class="header-anchor" href="#_7-锁" aria-hidden="true">#</a> 7. 锁</h2><p><strong>要求</strong></p><ul><li>了解全局锁</li><li>了解表级锁</li><li>掌握行级锁</li></ul><p><strong>全局锁</strong></p><p>用作全量备份时，保证<strong>表与表之间的数据一致性</strong></p><p>如果不加任何包含，数据备份时就可能产生不一致的情况，如下图所示</p><p><img src="/vuepress-java/assets/image-20210902090302805.25ff477f.png" alt="image-20210902090302805"></p><p>全局锁的语法：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>flush <span class="token keyword">tables</span> <span class="token keyword">with</span> <span class="token keyword">read</span> <span class="token keyword">lock</span><span class="token punctuation">;</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>使用全局读锁锁定所有数据库的所有表。这时会阻塞其它所有 DML 以及 DDL 操作，这样可以避免备份过程中的数据不一致。接下来可以执行备份，最后用 unlock tables 来解锁</li></ul><blockquote><p><em><strong>注意</strong></em></p><p>但 flush tables 属于比较重的操作，可以使用 --single-transaction 参数来完成不加锁的一致性备份（仅针对 InnoDB 引擎的表）</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysqldump <span class="token comment">--single-transaction -uroot -p test &gt; 1.sql</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><p><strong>表级锁 - 表锁</strong></p><ul><li>语法：加锁 lock tables 表名 read/write，解锁 unlock tables</li><li>缺点：粒度较粗，在 InnoDB 引擎很少使用</li></ul><p><strong>表级锁 - 元数据锁</strong></p><ul><li><p>即 metadata-lock（MDL），主要是为<strong>了避免 DML 与 DDL 冲突</strong>，DML 的元数据锁之间不互斥</p></li><li><p>加元数据锁的几种情况</p><ul><li><code>lock tables read/write</code>，类型为 SHARED_READ_ONLY 和 SHARED_NO_READ_WRITE</li><li><code>alter table</code>，类型为 EXCLUSIVE，与其它 MDL 都互斥</li><li><code>select，select … lock in share mode</code>，类型为 SHARED_READ</li><li><code>insert，update，delete，select for update</code>，类型为 SHARED_WRITE</li></ul></li><li><p>查看元数据锁（适用于 MySQL 8.0 以上版本）</p><ul><li><code>select object_type,object_schema,object_name,lock_type,lock_duration from performance_schema.metadata_locks;</code></li></ul></li></ul><p><strong>表级锁 - IS（意向共享） 与 IX（意向排他）</strong></p><ul><li>主要是<strong>避免 DML 与表锁冲突</strong>，DML 主要目的是加行锁，为了让表锁不用检查每行数据是否加锁，加意向锁（表级）来减少表锁的判断，意向锁之间不会互斥</li><li>加意向表锁的几种情况 <ul><li><code>select … lock in share mode</code> 会加 IS 锁</li><li><code>insert，update，delete， select … for update</code> 会加 IX 锁</li></ul></li><li>查看意向表锁（适用于 MySQL 8.0 以上版本） <ul><li><code>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;</code></li></ul></li></ul><p><strong>行级锁</strong></p><ul><li><p>种类</p><ul><li>行锁 – 在 RC 下，锁住的是行，防止其他事务对此行 update 或 delete</li><li>间隙锁 – 在 RR 下，锁住的是间隙，防止其他事务在这个间隙 insert 产生幻读</li><li>临键锁 – 在 RR 下，锁住的是前面间隙+行，特定条件下可优化为行锁</li></ul></li><li><p>查看行级锁</p><ul><li><code>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks where object_name=&#39;表名&#39;;</code></li></ul></li></ul><blockquote><p><em><strong>注意</strong></em></p><ul><li>它们锁定的其实都是<strong>索引</strong>上的行与间隙，根据索引的有序性来确定间隙</li></ul></blockquote><p>测试数据</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span>id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>age <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;zhangsan&#39;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;lisi&#39;</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;wangwu&#39;</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&#39;zhangsan&#39;</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">&#39;zhang&#39;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">&#39;zhang&#39;</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>说明</strong></p><ul><li>1,2,3,4 之间其实并不可能有间隙</li><li>4 与 8 之间有间隙</li><li>8 与 12 之间有间隙</li><li>12 与正无穷大之间有间隙</li><li>其实我们的例子中还有负无穷大与 1 之间的间隙，想避免负数可以通过建表时选择数据类型为 unsigned int</li></ul></blockquote><p>间隙锁例子</p><p>事务1：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">9</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span> <span class="token comment">/* 锁住的是 8 与 12 之间的间隙 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务2：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">/* 不会阻塞 */</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">/* 不会阻塞 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">&#39;aaa&#39;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>临键锁和记录锁例子</p><p>事务1：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">&gt;=</span> <span class="token number">8</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>临键锁锁定的是左开右闭的区间，与上条查询条件相关的区间有 (4,8]，(8,12]，(12,+∞)</li><li>临键锁在某些条件下可以被优化为记录锁，例如 (4,8] 被优化为只针对 8 的记录锁，前面的区间不会锁住</li></ul><p>事务2：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">&#39;aaa&#39;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 不会阻塞 */</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">&#39;aaa&#39;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">&#39;aaa&#39;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">最近更新时间: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">作者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 2279345175@qq.com">橘橙天下</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/vuepress-java/assets/app.8ebbe26f.js" defer></script>
  </body>
</html>
