<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/logut.png"><title>strongking</title><meta name="description" content="strongking博客">
    <link rel="modulepreload" href="/vuepress-java/assets/app.3c40b068.js"><link rel="modulepreload" href="/vuepress-java/assets/day10-实现推荐功能.html.10e2aebd.js"><link rel="modulepreload" href="/vuepress-java/assets/day10-实现推荐功能.html.18f97898.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.58c13695.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.0ef9893a.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.7e230503.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.d2a40853.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.dff1005a.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.89f2a13b.js"><link rel="prefetch" href="/vuepress-java/assets/Git课程讲义.html.879a5ecc.js"><link rel="prefetch" href="/vuepress-java/assets/Redis基础课程讲义.html.f8cf3fff.js"><link rel="prefetch" href="/vuepress-java/assets/EADME.html.5cde76f7.js"><link rel="prefetch" href="/vuepress-java/assets/基础篇讲义.html.028c762c.js"><link rel="prefetch" href="/vuepress-java/assets/并发篇讲义.html.d9e712e0.js"><link rel="prefetch" href="/vuepress-java/assets/虚拟机篇讲义.html.373ec939.js"><link rel="prefetch" href="/vuepress-java/assets/框架篇讲义.html.17209f9f.js"><link rel="prefetch" href="/vuepress-java/assets/缓存篇讲义.html.9cf7e368.js"><link rel="prefetch" href="/vuepress-java/assets/分布式讲义.html.46f4e374.js"><link rel="prefetch" href="/vuepress-java/assets/SpringCloud01.html.fc83a84b.js"><link rel="prefetch" href="/vuepress-java/assets/微服务保护.html.1de66ac9.js"><link rel="prefetch" href="/vuepress-java/assets/分布式事务.html.5b173621.js"><link rel="prefetch" href="/vuepress-java/assets/分布式缓存.html.5f46033d.js"><link rel="prefetch" href="/vuepress-java/assets/Docker实用篇.html.d5bfe35f.js"><link rel="prefetch" href="/vuepress-java/assets/RabbitMQ.html.14f02718.js"><link rel="prefetch" href="/vuepress-java/assets/多级缓存.html.1ff7b080.js"><link rel="prefetch" href="/vuepress-java/assets/数据库篇.html.2faba054.js"><link rel="prefetch" href="/vuepress-java/assets/RabbitMQ-高级篇.html.8aee4216.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day01.html.60edf774.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day02.html.498d5ffb.js"><link rel="prefetch" href="/vuepress-java/assets/Vmware虚拟机问题解决方案.html.5f6f36af.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day01.html.34dc44b9.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day02.html.e4378770.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day03.html.eb870fc0.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day01.html.a39cfbd7.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day02.html.a560b5b2.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day03.html.aab72058.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day04.html.95344022.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第五天.html.bf4c2590.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第六天.html.4a07be12.js"><link rel="prefetch" href="/vuepress-java/assets/mysql基础.html.f6ee5789.js"><link rel="prefetch" href="/vuepress-java/assets/mysql高级.html.e0e86232.js"><link rel="prefetch" href="/vuepress-java/assets/JDBC.html.587e6170.js"><link rel="prefetch" href="/vuepress-java/assets/Mybatis.html.6eaa3150.js"><link rel="prefetch" href="/vuepress-java/assets/HTML_CSS.html.1acf784d.js"><link rel="prefetch" href="/vuepress-java/assets/JavaScript.html.72e632c8.js"><link rel="prefetch" href="/vuepress-java/assets/HTTP_Tomcat_Servlet.html.ff09d6a5.js"><link rel="prefetch" href="/vuepress-java/assets/Request_Response.html.ce8099d4.js"><link rel="prefetch" href="/vuepress-java/assets/JSP.html.2e5e7f75.js"><link rel="prefetch" href="/vuepress-java/assets/Filter_Listener_Ajax.html.51ea1ed8.js"><link rel="prefetch" href="/vuepress-java/assets/SpringCloud实用篇02.html.4382200f.js"><link rel="prefetch" href="/vuepress-java/assets/day01-项目介绍以及实现登录功能.html.819c6109.js"><link rel="prefetch" href="/vuepress-java/assets/day02-完善个人信息与MongoDB入门.html.9258a082.js"><link rel="prefetch" href="/vuepress-java/assets/day03-今日佳人功能实现.html.34e74aea.js"><link rel="prefetch" href="/vuepress-java/assets/day04-圈子功能实现.html.1729fde6.js"><link rel="prefetch" href="/vuepress-java/assets/day05-圈子、小视频功能实现.html.889780f1.js"><link rel="prefetch" href="/vuepress-java/assets/day06-完善小视频功能以及即时通讯.html.49d85a44.js"><link rel="prefetch" href="/vuepress-java/assets/day07-完善消息功能以及个人主页.html.62de9965.js"><link rel="prefetch" href="/vuepress-java/assets/day08-搜附近以及探花功能实现.html.00cb6e1d.js"><link rel="prefetch" href="/vuepress-java/assets/day09-我的功能实现.html.f626a64b.js"><link rel="prefetch" href="/vuepress-java/assets/day02-分类和static.html.d516863f.js"><link rel="prefetch" href="/vuepress-java/assets/day03-继承.html.86897a52.js"><link rel="prefetch" href="/vuepress-java/assets/day04-接口和内部类.html.c2736fc5.js"><link rel="prefetch" href="/vuepress-java/assets/day05-常用API01.html.6ecedb9d.js"><link rel="prefetch" href="/vuepress-java/assets/day06-常用API02.html.2ddc942a.js"><link rel="prefetch" href="/vuepress-java/assets/day07集合01.html.a3ee5f56.js"><link rel="prefetch" href="/vuepress-java/assets/day09集合03.html.08d43cf0.js"><link rel="prefetch" href="/vuepress-java/assets/day10IO流01.html.f4d87ac3.js"><link rel="prefetch" href="/vuepress-java/assets/day11IO流02.html.3b6d400d.js"><link rel="prefetch" href="/vuepress-java/assets/day12-多线程01.html.25ea7383.js"><link rel="prefetch" href="/vuepress-java/assets/day12 多线程02.html.4b225d57.js"><link rel="prefetch" href="/vuepress-java/assets/day14-网络编程.html.b217db0f.js"><link rel="prefetch" href="/vuepress-java/assets/day16-基础加强01.html.abf7fad0.js"><link rel="prefetch" href="/vuepress-java/assets/day17-基础加强02.html.4806f20a.js"><link rel="prefetch" href="/vuepress-java/assets/day18-基础加强03.html.9615e037.js"><link rel="prefetch" href="/vuepress-java/assets/day08集合02.html.b5d501ee.js"><link rel="prefetch" href="/vuepress-java/assets/day08 常用API.html.25bcd08c.js"><link rel="prefetch" href="/vuepress-java/assets/day09 ArrayList_学生管理系统.html.60f09897.js"><link rel="prefetch" href="/vuepress-java/assets/day01Git.html.47aa810c.js"><link rel="prefetch" href="/vuepress-java/assets/day01-java基础语法.html.4bb04028.js"><link rel="prefetch" href="/vuepress-java/assets/day02-Java基础语法.html.a0e54849.js"><link rel="prefetch" href="/vuepress-java/assets/day03 switch_循环语句.html.fc7ce87f.js"><link rel="prefetch" href="/vuepress-java/assets/day04 IDEA_数组.html.bdcb893b.js"><link rel="prefetch" href="/vuepress-java/assets/day05 方法.html.ced2a258.js"><link rel="prefetch" href="/vuepress-java/assets/day06 Debug_基础练习.html.bbb54b26.js"><link rel="prefetch" href="/vuepress-java/assets/day07 面向对象.html.e99b9ad2.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第一天.html.9af90a81.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第二天.html.0f1f6ac5.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第三天.html.7a80cad2.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第一天.html.807d7335.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第二天.html.deff038b.js"><link rel="prefetch" href="/vuepress-java/assets/SpringBoot笔记.html.41b58db7.js"><link rel="prefetch" href="/vuepress-java/assets/MyBatisPlus笔记.html.224f3763.js"><link rel="prefetch" href="/vuepress-java/assets/Maven进阶笔记.html.67f9d23c.js"><link rel="prefetch" href="/vuepress-java/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.8fb18689.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.6f8f5138.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.16e311df.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.0237dd58.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.275c7223.js"><link rel="prefetch" href="/vuepress-java/assets/index.html.8effc5d4.js"><link rel="prefetch" href="/vuepress-java/assets/Git课程讲义.html.fce1f745.js"><link rel="prefetch" href="/vuepress-java/assets/Redis基础课程讲义.html.50010bcb.js"><link rel="prefetch" href="/vuepress-java/assets/EADME.html.da9531ba.js"><link rel="prefetch" href="/vuepress-java/assets/基础篇讲义.html.b623d1a9.js"><link rel="prefetch" href="/vuepress-java/assets/并发篇讲义.html.86b7a714.js"><link rel="prefetch" href="/vuepress-java/assets/虚拟机篇讲义.html.366debbe.js"><link rel="prefetch" href="/vuepress-java/assets/框架篇讲义.html.0797b14d.js"><link rel="prefetch" href="/vuepress-java/assets/缓存篇讲义.html.0ef7cdf7.js"><link rel="prefetch" href="/vuepress-java/assets/分布式讲义.html.4e53ba7c.js"><link rel="prefetch" href="/vuepress-java/assets/SpringCloud01.html.d59cbf24.js"><link rel="prefetch" href="/vuepress-java/assets/微服务保护.html.3431e9f7.js"><link rel="prefetch" href="/vuepress-java/assets/分布式事务.html.a8fb5496.js"><link rel="prefetch" href="/vuepress-java/assets/分布式缓存.html.dee5d876.js"><link rel="prefetch" href="/vuepress-java/assets/Docker实用篇.html.a3a427e2.js"><link rel="prefetch" href="/vuepress-java/assets/RabbitMQ.html.8f98ff1c.js"><link rel="prefetch" href="/vuepress-java/assets/多级缓存.html.6c138013.js"><link rel="prefetch" href="/vuepress-java/assets/数据库篇.html.48118cff.js"><link rel="prefetch" href="/vuepress-java/assets/RabbitMQ-高级篇.html.a2287ed1.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day01.html.36242c0e.js"><link rel="prefetch" href="/vuepress-java/assets/Linux-Day02.html.86503b27.js"><link rel="prefetch" href="/vuepress-java/assets/Vmware虚拟机问题解决方案.html.c97129f1.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day01.html.7cd0aac9.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day02.html.90dbf7d4.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖项目优化-Day03.html.f1312c06.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day01.html.953d6998.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day02.html.d63a9ce7.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day03.html.a806f77e.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-Day04.html.71f58ed4.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第五天.html.6aedb5f6.js"><link rel="prefetch" href="/vuepress-java/assets/瑞吉外卖-第六天.html.f6956792.js"><link rel="prefetch" href="/vuepress-java/assets/mysql基础.html.2fe43ce2.js"><link rel="prefetch" href="/vuepress-java/assets/mysql高级.html.422e1eb4.js"><link rel="prefetch" href="/vuepress-java/assets/JDBC.html.d5102219.js"><link rel="prefetch" href="/vuepress-java/assets/Mybatis.html.64288e8b.js"><link rel="prefetch" href="/vuepress-java/assets/HTML_CSS.html.7904ed96.js"><link rel="prefetch" href="/vuepress-java/assets/JavaScript.html.4a93f57b.js"><link rel="prefetch" href="/vuepress-java/assets/HTTP_Tomcat_Servlet.html.a6f517ab.js"><link rel="prefetch" href="/vuepress-java/assets/Request_Response.html.b33419cc.js"><link rel="prefetch" href="/vuepress-java/assets/JSP.html.95986fdb.js"><link rel="prefetch" href="/vuepress-java/assets/Filter_Listener_Ajax.html.5670cfea.js"><link rel="prefetch" href="/vuepress-java/assets/SpringCloud实用篇02.html.9f82b556.js"><link rel="prefetch" href="/vuepress-java/assets/day01-项目介绍以及实现登录功能.html.15359fc4.js"><link rel="prefetch" href="/vuepress-java/assets/day02-完善个人信息与MongoDB入门.html.92f0e42e.js"><link rel="prefetch" href="/vuepress-java/assets/day03-今日佳人功能实现.html.8bd618a4.js"><link rel="prefetch" href="/vuepress-java/assets/day04-圈子功能实现.html.e5c89612.js"><link rel="prefetch" href="/vuepress-java/assets/day05-圈子、小视频功能实现.html.c2a42d02.js"><link rel="prefetch" href="/vuepress-java/assets/day06-完善小视频功能以及即时通讯.html.816d65aa.js"><link rel="prefetch" href="/vuepress-java/assets/day07-完善消息功能以及个人主页.html.bb5fea9f.js"><link rel="prefetch" href="/vuepress-java/assets/day08-搜附近以及探花功能实现.html.dcd03216.js"><link rel="prefetch" href="/vuepress-java/assets/day09-我的功能实现.html.efbf4feb.js"><link rel="prefetch" href="/vuepress-java/assets/day02-分类和static.html.e583adfb.js"><link rel="prefetch" href="/vuepress-java/assets/day03-继承.html.b2abf2a9.js"><link rel="prefetch" href="/vuepress-java/assets/day04-接口和内部类.html.6e8c24fa.js"><link rel="prefetch" href="/vuepress-java/assets/day05-常用API01.html.2f331440.js"><link rel="prefetch" href="/vuepress-java/assets/day06-常用API02.html.46447d21.js"><link rel="prefetch" href="/vuepress-java/assets/day07集合01.html.1098c9f0.js"><link rel="prefetch" href="/vuepress-java/assets/day09集合03.html.acbecdaf.js"><link rel="prefetch" href="/vuepress-java/assets/day10IO流01.html.65fe38ef.js"><link rel="prefetch" href="/vuepress-java/assets/day11IO流02.html.51d13187.js"><link rel="prefetch" href="/vuepress-java/assets/day12-多线程01.html.b977e43b.js"><link rel="prefetch" href="/vuepress-java/assets/day12 多线程02.html.1b18ea1e.js"><link rel="prefetch" href="/vuepress-java/assets/day14-网络编程.html.bd8edf2e.js"><link rel="prefetch" href="/vuepress-java/assets/day16-基础加强01.html.cdf433cc.js"><link rel="prefetch" href="/vuepress-java/assets/day17-基础加强02.html.53bdb316.js"><link rel="prefetch" href="/vuepress-java/assets/day18-基础加强03.html.9b1aeb93.js"><link rel="prefetch" href="/vuepress-java/assets/day08集合02.html.b1bfb9dc.js"><link rel="prefetch" href="/vuepress-java/assets/day08 常用API.html.3a70d707.js"><link rel="prefetch" href="/vuepress-java/assets/day09 ArrayList_学生管理系统.html.e227f01d.js"><link rel="prefetch" href="/vuepress-java/assets/day01Git.html.f7d41203.js"><link rel="prefetch" href="/vuepress-java/assets/day01-java基础语法.html.c752b285.js"><link rel="prefetch" href="/vuepress-java/assets/day02-Java基础语法.html.2c79074a.js"><link rel="prefetch" href="/vuepress-java/assets/day03 switch_循环语句.html.5af447cc.js"><link rel="prefetch" href="/vuepress-java/assets/day04 IDEA_数组.html.2969203b.js"><link rel="prefetch" href="/vuepress-java/assets/day05 方法.html.adff6b09.js"><link rel="prefetch" href="/vuepress-java/assets/day06 Debug_基础练习.html.5198735f.js"><link rel="prefetch" href="/vuepress-java/assets/day07 面向对象.html.12615bf3.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第一天.html.c3817523.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第二天.html.eb8887e1.js"><link rel="prefetch" href="/vuepress-java/assets/Spring第三天.html.eb18453e.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第一天.html.aad028a5.js"><link rel="prefetch" href="/vuepress-java/assets/SpringMVC第二天.html.9e4906c3.js"><link rel="prefetch" href="/vuepress-java/assets/SpringBoot笔记.html.91a615e0.js"><link rel="prefetch" href="/vuepress-java/assets/MyBatisPlus笔记.html.591cca9c.js"><link rel="prefetch" href="/vuepress-java/assets/Maven进阶笔记.html.514fd156.js"><link rel="prefetch" href="/vuepress-java/assets/404.html.3813a582.js">
    <link rel="stylesheet" href="/vuepress-java/assets/style.4362bf7c.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vuepress-java/" class=""><img class="logo" src="/vuepress-java/images/logut.png" alt="strongking"><span class="site-name can-hide">strongking</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/vuepress-java/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/java/" class="" aria-label="java"><!--[--><!--]--> java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/interview/" class="" aria-label="java面试"><!--[--><!--]--> java面试 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/gitredis/" class="" aria-label="GitRedis"><!--[--><!--]--> GitRedis <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/java8-9/" class="router-link-active" aria-label="java分布式"><!--[--><!--]--> java分布式 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/vuepress-java/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/java/" class="" aria-label="java"><!--[--><!--]--> java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/interview/" class="" aria-label="java面试"><!--[--><!--]--> java面试 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/gitredis/" class="" aria-label="GitRedis"><!--[--><!--]--> GitRedis <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress-java/java8-9/" class="router-link-active" aria-label="java分布式"><!--[--><!--]--> java分布式 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">java分布式 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vuepress-java/java8-9/day01-SpringCloud01/讲义/SpringCloud01.md" class="sidebar-item" aria-label="SpringCloud01"><!--[--><!--]--> SpringCloud01 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/SpringCloud02/讲义/md/SpringCloud实用篇02.md" class="sidebar-item" aria-label="SpringCloud02"><!--[--><!--]--> SpringCloud02 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day03-Docker/讲义/Docker实用篇.md" class="sidebar-item" aria-label="Docker实用篇"><!--[--><!--]--> Docker实用篇 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day04-MQ/讲义/RabbitMQ.md" class="sidebar-item" aria-label="RabbitMQ"><!--[--><!--]--> RabbitMQ <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day01-微服务保护/讲义/微服务保护.md" class="sidebar-item" aria-label="微服务"><!--[--><!--]--> 微服务 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day02-分布式事务/讲义/分布式事务.md" class="sidebar-item" aria-label="分布式事务"><!--[--><!--]--> 分布式事务 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day03-分布式缓存/讲义/分布式缓存.md" class="sidebar-item" aria-label="分布式缓存"><!--[--><!--]--> 分布式缓存 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day04-多级缓存/讲义/多级缓存.md" class="sidebar-item" aria-label="多级缓存"><!--[--><!--]--> 多级缓存 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/day05/讲义/RabbitMQ-高级篇.md" class="sidebar-item" aria-label="RabbitMQ-高级篇"><!--[--><!--]--> RabbitMQ-高级篇 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">交友软件 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vuepress-java/java8-9/探花交友/day01-项目介绍以及实现登录功能/讲义-md版本/day01-项目介绍以及实现登录功能.md" class="sidebar-item" aria-label="项目介绍以及实现登录功能"><!--[--><!--]--> 项目介绍以及实现登录功能 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day02-完善个人信息与MongoDB入门/讲义-md版本/day02-完善个人信息与MongoDB入门.md" class="sidebar-item" aria-label="完善个人信息与MongoDB入门"><!--[--><!--]--> 完善个人信息与MongoDB入门 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day03-今日佳人功能实现/讲义-md版本/day03-今日佳人功能实现.md" class="sidebar-item" aria-label="今日佳人功能实现"><!--[--><!--]--> 今日佳人功能实现 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day04-圈子功能实现/讲义-md版本/day04-圈子功能实现.md" class="sidebar-item" aria-label="圈子功能实现"><!--[--><!--]--> 圈子功能实现 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day05-圈子、小视频功能实现/讲义-md版本/day05-圈子、小视频功能实现.md" class="sidebar-item" aria-label="圈子、小视频功能实现"><!--[--><!--]--> 圈子、小视频功能实现 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day06-完善小视频功能以及即时通讯/讲义-md版本/day06-完善小视频功能以及即时通讯.md" class="sidebar-item" aria-label="完善小视频功能以及即时通讯"><!--[--><!--]--> 完善小视频功能以及即时通讯 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day07-完善消息功能以及个人主页/讲义-md版本/day07-完善消息功能以及个人主页.md" class="sidebar-item" aria-label="完善消息功能以及个人主页"><!--[--><!--]--> 完善消息功能以及个人主页 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day08-搜附近以及探花功能实现/讲义-md版本/day08-搜附近以及探花功能实现.md" class="sidebar-item" aria-label="搜附近以及探花功能实现"><!--[--><!--]--> 搜附近以及探花功能实现 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day09-我的功能实现/讲义-md版本/day09-我的功能实现.md" class="sidebar-item" aria-label="我的功能实现"><!--[--><!--]--> 我的功能实现 <!--[--><!--]--></a><!----></li><li><a href="/vuepress-java/java8-9/探花交友/day10-实现推荐功能/讲义-md版本/day10-实现推荐功能.md" class="sidebar-item active" aria-label="实现推荐功能"><!--[--><!--]--> 实现推荐功能 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h2 id="课程说明" tabindex="-1"><a class="header-anchor" href="#课程说明" aria-hidden="true">#</a> 课程说明</h2><ul><li>了解推荐系统</li><li>实现好友的推荐</li><li>圈子推荐功能说明</li><li>圈子推荐功能流程</li><li>圈子推荐功能的实现</li><li>小视频推荐功能的实现</li></ul><h2 id="_1、了解推荐系统" tabindex="-1"><a class="header-anchor" href="#_1、了解推荐系统" aria-hidden="true">#</a> 1、了解推荐系统</h2><h3 id="_1-1、什么是推荐系统" tabindex="-1"><a class="header-anchor" href="#_1-1、什么是推荐系统" aria-hidden="true">#</a> 1.1、什么是推荐系统？</h3><p><strong>为了解决信息过载和用户无明确需求的问题，找到用户感兴趣的物品，才有了个性化推荐系统。</strong></p><p>其实，解决信息过载的问题，代表性的解决方案是分类目录和搜索引擎，如hao123，电商首页的分类目录以及百度，360搜索等。</p><p>不过分类目录和搜索引擎只能解决用户主动查找信息的需求，即用户知道自己想要什么，并不能解决用户没用明确需求很随便的问题。</p><p>经典语录是：你想吃什么，随便！面对这种很随便又得罪不起的用户（女友和上帝），只能<strong>通过分析用户的历史行为给用户的兴趣建模</strong>，从而主动给用户推荐能够满足他们兴趣和需求的信息。比如问问女友的闺蜜，她一般什么时候喜欢吃什么。</p><h3 id="_1-2、电商是推荐系统的先行者" tabindex="-1"><a class="header-anchor" href="#_1-2、电商是推荐系统的先行者" aria-hidden="true">#</a> 1.2、电商是推荐系统的先行者</h3><ul><li>[ ] 电子商务网站是个性化推荐系统重要地应用的领域之一，亚马逊就是个性化推荐系统的积极应用者和推广者，亚马逊的推荐系统深入到网站的各类商品，为亚马逊带来了至少30%的销售额。</li><li>[ ] 不光是电商类，推荐系统无处不在。QQ，微信的好友推荐；新浪微博的你可能感兴趣的人；优酷，土豆的电影推荐；豆瓣的图书推荐；大从点评的餐饮推荐；脉脉的同事推荐等。</li><li>[ ] 推荐引擎的鼻祖思想源泉：http://portal.acm.org/citation.cfm?id=1070751</li><li>[ ] 亚马逊最早提出基亍物品的协同过滤推荐算法：http://portal.acm.org/citation.cfm?id=372071</li></ul><p>京东的推荐： <img src="/vuepress-java/assets/1533027301281.14d50be2.png" alt="1533027301281"></p><h3 id="_1-3、推荐系统业务流程" tabindex="-1"><a class="header-anchor" href="#_1-3、推荐系统业务流程" aria-hidden="true">#</a> 1.3、推荐系统业务流程</h3><p><img src="/vuepress-java/assets/1533027789007.70ac8f76.png" alt="1533027789007"></p><p>推荐系统广泛存在于各类网站中，作为一个应用为用户提供个性化的推荐。它需要一些用户的历史数据，一般由三个部分组成：基础数据、推荐算法系统、前台展示。</p><ul><li>基础数据包括很多维度，包括用户的访问、浏览、下单、收藏，用户的历史订单信息，评价信息等很多信息；</li><li>推荐算法系统主要是根据不同的推荐诉求由多个算法组成的推荐模型；</li><li>前台展示主要是对客户端系统进行响应，返回相关的推荐信息以供展示。</li></ul><h3 id="_1-4、协同过滤推荐算法" tabindex="-1"><a class="header-anchor" href="#_1-4、协同过滤推荐算法" aria-hidden="true">#</a> 1.4、协同过滤推荐算法</h3><p>迄今为止，在个性化推荐系统中，协同过滤技术是应用最成功的技术。目前国内外有许多大型网站应用这项技术为用户更加智能（个性化、千人千面）的推荐内容。</p><blockquote><p>核心思想：</p><p>协同过滤一般是在海量的用户中发掘出一小部分和你品位比较类似的，在协同过滤中，这些用户成为邻居，然后根据他们喜欢的其他东西组织成一个排序的目彔作为推荐给你。</p></blockquote><h4 id="_1-4-1、基于用户的推荐-usercf" tabindex="-1"><a class="header-anchor" href="#_1-4-1、基于用户的推荐-usercf" aria-hidden="true">#</a> 1.4.1、基于用户的推荐 UserCF</h4><p><img src="/vuepress-java/assets/1533029239312.5d31bb2c.png" alt="1533029239312"></p><p><img src="/vuepress-java/assets/1533029506213-1611629706240.d967e217.png" alt="1533029506213"></p><p>对于用户A，根据用户的历史偏好，这里只计算得到一个邻居–用户C，然后将用户C 喜欢的物品D 推荐给用户A。</p><p>基于用户的协同过滤算法先计算的是用户与用户的相似度（兴趣相投，物以类聚人以群分），然后将相似度比较接近的用户A购买的物品推荐给用户B，专业的说法是该算法用最近邻居（nearest-neighbor）算法找出一个用户的邻居集合，该集合的用户和该用户有相似的喜好，算法根据邻居的偏好对该用户进行预测。</p><h4 id="_1-4-2、基于商品的推荐-itemcf" tabindex="-1"><a class="header-anchor" href="#_1-4-2、基于商品的推荐-itemcf" aria-hidden="true">#</a> 1.4.2、基于商品的推荐 ItemCF</h4><p><img src="/vuepress-java/assets/1533042920915.ec14bbb5.png" alt="1533042920915"></p><ul><li>基于ItemCF的原理和基于UserCF类似，只是在计算邻居时采用物品本身，而不是从用户的角度，即基于用户对物品的偏好找到相似的物品，然后根据用户的历史偏好，推荐相似的物品给他。</li><li>从计算的角度看，就是将所有用户对某个物品的偏好作为一个向量来计算物品之间的相似度，得到物品的相似物品后，根据用户历史的偏好预测当前用户还没有表示偏好的物品，计算得到一个排序的物品列表作为推荐。</li><li>解释：对于物品A，根据所有用户的历史偏好，喜欢物品A 的用户都喜欢物品C，得出物品A 和物品C 比较相似，而用户C 喜欢物品A，那么可以推断出用户C 可能也喜欢物品C。</li></ul><h3 id="_1-5、als算法" tabindex="-1"><a class="header-anchor" href="#_1-5、als算法" aria-hidden="true">#</a> 1.5、ALS算法</h3><p>ALS 是交替最小二乘 （alternating least squares）的简称。在机器学习的上下文中，ALS 特指使用交替最小二乘求解的一个协同推荐算法。它通过观察到的所有用户给产品的打分，来推断每个用户的喜好并向用户推荐适合的产品。从协同过滤的分类来说，ALS算法属于User-Item CF，也叫做混合CF。它同时考虑了User和Item两个方面。</p><p>用户和商品的关系，可以抽象为如下的三元组：&lt;User,Item,Rating&gt;。其中，Rating是用户对商品的评分，表征用户对该商品的喜好程度。如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">196</span>	<span class="token number">242</span>	<span class="token number">3</span>	<span class="token number">881250949</span>
<span class="token number">186</span>	<span class="token number">302</span>	<span class="token number">3</span>	<span class="token number">891717742</span>
<span class="token number">22</span>	<span class="token number">377</span>	<span class="token number">1</span>	<span class="token number">878887116</span>
<span class="token number">244</span>	<span class="token number">51</span>	<span class="token number">2</span>	<span class="token number">880606923</span>
<span class="token number">166</span>	<span class="token number">346</span>	<span class="token number">1</span>	<span class="token number">886397596</span>
<span class="token number">298</span>	<span class="token number">474</span>	<span class="token number">4</span>	<span class="token number">884182806</span>
<span class="token number">115</span>	<span class="token number">265</span>	<span class="token number">2</span>	<span class="token number">881171488</span>
<span class="token number">253</span>	<span class="token number">465</span>	<span class="token number">5</span>	<span class="token number">891628467</span>
<span class="token number">305</span>	<span class="token number">451</span>	<span class="token number">3</span>	<span class="token number">886324817</span>
<span class="token number">6</span>	<span class="token number">86</span>	<span class="token number">3</span>	<span class="token number">883603013</span>
<span class="token number">62</span>	<span class="token number">257</span>	<span class="token number">2</span>	<span class="token number">879372434</span>
<span class="token number">286</span>	<span class="token number">1014</span>	<span class="token number">5</span>	<span class="token number">879781125</span>
<span class="token number">200</span>	<span class="token number">222</span>	<span class="token number">5</span>	<span class="token number">876042340</span>
<span class="token number">210</span>	<span class="token number">40</span>	<span class="token number">3</span>	<span class="token number">891035994</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、好友推荐" tabindex="-1"><a class="header-anchor" href="#_2、好友推荐" aria-hidden="true">#</a> 2、好友推荐</h2><p>对于好友的推荐，需要找出每个用户之间的相似性，具体规则如下：</p><table><thead><tr><th>字段</th><th>权重分</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>年龄差</td><td>0-2岁 30分</td><td>3-5 20分</td><td>5-10岁 10分</td><td>10岁以上 0分</td></tr><tr><td>性别</td><td>异性 30分</td><td>同性 0分</td><td></td><td></td></tr><tr><td>位置</td><td>同城 20分</td><td>不同 0分</td><td></td><td></td></tr><tr><td>学历</td><td>相同 20分</td><td>不同 0分</td><td></td><td></td></tr></tbody></table><h3 id="_2-1、流程" tabindex="-1"><a class="header-anchor" href="#_2-1、流程" aria-hidden="true">#</a> 2.1、流程</h3><p><img src="/vuepress-java/assets/image-20210127101912885.3421842e.png" alt="image-20210127101912885"></p><h3 id="_2-2、部署好友推荐服务" tabindex="-1"><a class="header-anchor" href="#_2-2、部署好友推荐服务" aria-hidden="true">#</a> 2.2、部署好友推荐服务</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#拉取镜像</span>
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-recommend-user:1.0.1

<span class="token comment">#创建容器</span>
<span class="token function">docker</span> create <span class="token parameter variable">--name</span> tanhua-spark-recommend-user <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_HOST</span><span class="token operator">=</span><span class="token number">192.168</span>.31.81 <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_PORT</span><span class="token operator">=</span><span class="token number">27017</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_USERNAME</span><span class="token operator">=</span>tanhua <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_PASSWORD</span><span class="token operator">=</span>l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_DATABASE</span><span class="token operator">=</span>tanhua <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_COLLECTION</span><span class="token operator">=</span>recommend_user <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">JDBC_URL</span><span class="token operator">=</span><span class="token string">&quot;jdbc:mysql://192.168.31.81:3306/mytanhua?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">JDBC_DRIVER</span><span class="token operator">=</span>com.mysql.jdbc.Driver <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">JDBC_USER</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">JDBC_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">JDBC_TABLE</span><span class="token operator">=</span>tb_user_info <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">SCHEDULE_PERIOD</span><span class="token operator">=</span><span class="token number">30</span> <span class="token punctuation">\</span>
registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-recommend-user:1.0.1

<span class="token comment">#参数说明</span>
<span class="token comment">#MONGODB_HOST mongodb服务的地址</span>
<span class="token comment">#MONGODB_PORT mongodb服务的端口</span>
<span class="token comment">#MONGODB_USERNAME mongodb服务的认证用户名</span>
<span class="token comment">#MONGODB_PASSWORD mongodb服务的认证密码</span>
<span class="token comment">#MONGODB_DATABASE mongodb连接的数据库</span>
<span class="token comment">#MONGODB_COLLECTION 操作表</span>
<span class="token comment">#JDBC_URL  mysql数据库连接地址</span>
<span class="token comment">#JDBC_DRIVER  jdbc驱动</span>
<span class="token comment">#JDBC_USER  数据库连接用户名</span>
<span class="token comment">#JDBC_PASSWORD  数据库连接密码</span>
<span class="token comment">#JDBC_TABLE  数据库表名</span>
<span class="token comment">#SCHEDULE_PERIOD  下次执行时间间隔，但是为分，默认为10分钟</span>

<span class="token comment">#启动服务</span>
<span class="token function">docker</span> start tanhua-spark-recommend-user
<span class="token comment">#查看日志</span>
<span class="token function">docker</span> logs <span class="token parameter variable">-f</span> tanhua-spark-recommend-user
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行完成后，可以看到MongoDB中的recommend_user表中数据已经重新生成了。</p><h2 id="_3、圈子推荐" tabindex="-1"><a class="header-anchor" href="#_3、圈子推荐" aria-hidden="true">#</a> 3、圈子推荐</h2><h3 id="_3-1、功能说明" tabindex="-1"><a class="header-anchor" href="#_3-1、功能说明" aria-hidden="true">#</a> 3.1、功能说明</h3><p>在圈子功能中，针对于用户发布的动态信息，系统可以根据用户的发布、浏览、点赞等操作，对动态信息做计算，然后对每个用户进行不同的推荐。</p><h3 id="_3-2、流程说明" tabindex="-1"><a class="header-anchor" href="#_3-2、流程说明" aria-hidden="true">#</a> 3.2、流程说明</h3><p><img src="/vuepress-java/assets/image-20210126143347337.021073f8.png" alt="image-20210126143347337"></p><p>流程说明：</p><ul><li>用户对圈子的动态操作，如：发布、浏览、点赞、喜欢等，就会给RocketMQ进行发送消息；</li><li>推荐系统接收消息，并且处理消息数据，处理之后将结果数据写入到MongoDB中；</li><li>Spark系统拉取数据，然后进行推荐计算；</li><li>计算之后的结果数据写入到Redis中，为每个用户都进行个性化推荐；</li></ul><h3 id="_3-3、动态计分规则" tabindex="-1"><a class="header-anchor" href="#_3-3、动态计分规则" aria-hidden="true">#</a> 3.3、动态计分规则</h3><ul><li>浏览 +1</li><li>点赞 +5</li><li>喜欢 +8</li><li>评论 + 10</li><li>发布动态 <ul><li>文字长度：50以内1分，50~100之间2分，100以上3分</li><li>图片个数：每个图片一分</li></ul></li></ul><p>核心推荐逻辑：</p><ul><li>推荐模型：用户 | 动态 | 评分</li><li>其中，评分是用户对动态操作的得分合计</li><li>为什么自己发布动态还要计分？ 是因为，自己发布就相当于自己对此动态也感兴趣，这样就可以在相似的人之间进行推荐了。</li></ul><h3 id="_3-4、发送消息" tabindex="-1"><a class="header-anchor" href="#_3-4、发送消息" aria-hidden="true">#</a> 3.4、发送消息</h3><h4 id="_3-4-1、quanzimqservice" tabindex="-1"><a class="header-anchor" href="#_3-4-1、quanzimqservice" aria-hidden="true">#</a> 3.4.1、QuanziMQService</h4><p>my-tanhua-server增加依赖：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--RocketMQ相关--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件：</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># RocketMQ相关配置</span>
<span class="token key attr-name">rocketmq.name-server</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.31.81:9876</span>
<span class="token key attr-name">rocketmq.producer.group</span><span class="token punctuation">=</span><span class="token value attr-value">tanhua</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserThreadLocal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">QuanZiApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Publish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuanziMQService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanZiApi</span> quanZiApi<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 发布动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">publishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 浏览动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryPublishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 点赞动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">likePublishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 取消点赞动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">disLikePublishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 喜欢动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">lovePublishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 取消喜欢动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">disLovePublishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 评论动态消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">commentPublishMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 发送圈子操作相关的消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">type</span>      1-发动态，2-浏览动态， 3-点赞， 4-喜欢， 5-评论，6-取消点赞，7-取消喜欢
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryPublishById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//构建消息</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;pid&quot;</span><span class="token punctuation">,</span> publish<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;tanhua-quanzi&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败! publishId = &quot;</span> <span class="token operator">+</span> publishId <span class="token operator">+</span> <span class="token string">&quot;, type = &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2、修改quanziservice" tabindex="-1"><a class="header-anchor" href="#_3-4-2、修改quanziservice" aria-hidden="true">#</a> 3.4.2、修改QuanZiService</h4><p>在QuanZiService完成发送消息方法调用。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span><span class="token class-name">BeanUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">CollUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">DateUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">UserInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PicUploadService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">RelativeDateFormat</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserThreadLocal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PicUploadResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">QuanZiApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">VisitorsApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Comment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Publish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Visitors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">CommentVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">QuanZiVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">VisitorsVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuanZiService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanZiApi</span> quanZiApi<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">VisitorsApi</span> visitorsApi<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfoService</span> userInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PicUploadService</span> picUploadService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanziMQService</span> quanziMQService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryPublishList</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//分析：通过dubbo中的服务查询用户的好友动态</span>
        <span class="token comment">//通过mysql查询用户的信息，回写到结果对象中（QuanZiVo）</span>

        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//直接从ThreadLocal中获取对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//通过dubbo查询数据</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Publish</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryPublishList</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Publish</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillQuanZiVo</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 填充用户信息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userInfo</span>
     * <span class="token keyword">@param</span> <span class="token parameter">quanZiVo</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillUserInfoToQuanZiVo</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">,</span> <span class="token class-name">QuanZiVo</span> quanZiVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> quanZiVo<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//当前用户</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        quanZiVo<span class="token punctuation">.</span><span class="token function">setCommentCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO 评论数</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span><span class="token string">&quot;1.2公里&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO 距离</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是否点赞（1是，0否）</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//点赞数</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setHasLoved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLove</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是否喜欢（1是，0否）</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setLoveCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLoveCount</span><span class="token punctuation">(</span>quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//喜欢数</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 根据查询到的publish集合填充QuanZiVo对象
     *
     * <span class="token keyword">@param</span> <span class="token parameter">records</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QuanZiVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">fillQuanZiVo</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Publish</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QuanZiVo</span><span class="token punctuation">&gt;</span></span> quanZiVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>publish <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">QuanZiVo</span> quanZiVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuanZiVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            quanZiVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            quanZiVo<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            quanZiVo<span class="token punctuation">.</span><span class="token function">setImageContent</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getMedias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            quanZiVo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            quanZiVo<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">RelativeDateFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            quanZiVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>quanZiVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询用户信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userInfoService<span class="token punctuation">.</span><span class="token function">queryUserInfoByUserIdList</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">QuanZiVo</span> quanZiVo <span class="token operator">:</span> quanZiVoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//找到对应的用户信息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo <span class="token operator">:</span> userInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>quanZiVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillUserInfoToQuanZiVo</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> quanZiVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> quanZiVoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 发布动态
     *
     * <span class="token keyword">@param</span> <span class="token parameter">textContent</span>
     * <span class="token keyword">@param</span> <span class="token parameter">location</span>
     * <span class="token keyword">@param</span> <span class="token parameter">latitude</span>
     * <span class="token keyword">@param</span> <span class="token parameter">longitude</span>
     * <span class="token keyword">@param</span> <span class="token parameter">multipartFile</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">savePublish</span><span class="token punctuation">(</span><span class="token class-name">String</span> textContent<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> location<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> latitude<span class="token punctuation">,</span>
                              <span class="token class-name">String</span> longitude<span class="token punctuation">,</span>
                              <span class="token class-name">MultipartFile</span><span class="token punctuation">[</span><span class="token punctuation">]</span> multipartFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询当前的登录信息</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        publish<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        publish<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>textContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        publish<span class="token punctuation">.</span><span class="token function">setLocationName</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        publish<span class="token punctuation">.</span><span class="token function">setLatitude</span><span class="token punctuation">(</span>latitude<span class="token punctuation">)</span><span class="token punctuation">;</span>
        publish<span class="token punctuation">.</span><span class="token function">setLongitude</span><span class="token punctuation">(</span>longitude<span class="token punctuation">)</span><span class="token punctuation">;</span>
        publish<span class="token punctuation">.</span><span class="token function">setSeeType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> picUrls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//图片上传</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file <span class="token operator">:</span> multipartFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">PicUploadResult</span> picUploadResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>picUploadService<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            picUrls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>picUploadResult<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        publish<span class="token punctuation">.</span><span class="token function">setMedias</span><span class="token punctuation">(</span>picUrls<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> publishId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">savePublish</span><span class="token punctuation">(</span>publish<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//发送消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">publishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> publishId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryRecommendPublishList</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//分析：通过dubbo中的服务查询系统推荐动态</span>
        <span class="token comment">//通过mysql查询用户的信息，回写到结果对象中（QuanZiVo）</span>

        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//直接从ThreadLocal中获取对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//通过dubbo查询数据</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Publish</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryRecommendPublishList</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Publish</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillQuanZiVo</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 动态点赞
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">likeComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">//发消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">likePublishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//查询点赞数</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 动态的取消点赞
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">disLikeComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//发消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">disLikePublishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查询点赞数</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">loveComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//喜欢</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">loveComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//发消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">lovePublishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查询喜欢数</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLoveCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">disLoveComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//取消喜欢</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">disLoveComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//发消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">disLovePublishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查询喜欢数</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLoveCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">QuanZiVo</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryPublishById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>publish <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//发消息</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">queryPublishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillQuanZiVo</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>publish<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 查询评论列表
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryCommentList</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询评论列表数据</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryCommentList</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//查询用户信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userIdList <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userInfoService<span class="token punctuation">.</span><span class="token function">queryUserInfoByUserIdList</span><span class="token punctuation">(</span>userIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommentVo</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Comment</span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommentVo</span> commentVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommentVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//是否点赞</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> commentVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//点赞数</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>commentVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo <span class="token operator">:</span> userInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

                    commentVo<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    commentVo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>commentVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 发表评论
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">content</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">saveComments</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//发消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>quanziMQService<span class="token punctuation">.</span><span class="token function">commentPublishMsg</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryAlbumList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询数据</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Publish</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryAlbumList</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//填充数据</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillQuanZiVo</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VisitorsVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryVisitorsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Visitors</span><span class="token punctuation">&gt;</span></span> visitorsList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>visitorsApi<span class="token punctuation">.</span><span class="token function">queryMyVisitor</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>visitorsList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>visitorsList<span class="token punctuation">,</span> <span class="token string">&quot;visitorUserId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userInfoService<span class="token punctuation">.</span><span class="token function">queryUserInfoByUserIdList</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VisitorsVo</span><span class="token punctuation">&gt;</span></span> visitorsVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Visitors</span> visitor <span class="token operator">:</span> visitorsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo <span class="token operator">:</span> userInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>visitor<span class="token punctuation">.</span><span class="token function">getVisitorUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token class-name">VisitorsVo</span> visitorsVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VisitorsVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    visitorsVo<span class="token punctuation">.</span><span class="token function">setFateValue</span><span class="token punctuation">(</span>visitor<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    visitorsVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>visitorsVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> visitorsVoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5、接收消息" tabindex="-1"><a class="header-anchor" href="#_3-5、接收消息" aria-hidden="true">#</a> 3.5、接收消息</h3><p>接收消息的工作需要新创建my-tanhua-recommend工程，在此工程中完成相关的操作。</p><h4 id="_3-5-1、创建my-tanhua-recommend工程" tabindex="-1"><a class="header-anchor" href="#_3-5-1、创建my-tanhua-recommend工程" aria-hidden="true">#</a> 3.5.1、创建my-tanhua-recommend工程</h4><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>my-tanhua<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.itcast.tanhua<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>my-tanhua-recommend<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--引入interface依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.itcast.tanhua<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>my-tanhua-dubbo-interface<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-mongodb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--RocketMQ相关--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>joda-time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>joda-time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-2、配置文件" tabindex="-1"><a class="header-anchor" href="#_3-5-2、配置文件" aria-hidden="true">#</a> 3.5.2、配置文件</h4><p>application.properties</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.application.name</span> <span class="token punctuation">=</span> <span class="token value attr-value">itcast-rocketmq</span>
<span class="token key attr-name">server.port</span> <span class="token punctuation">=</span> <span class="token value attr-value">18082</span>

<span class="token comment"># RocketMQ相关配置</span>
<span class="token key attr-name">rocketmq.name-server</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.31.81:9876</span>
<span class="token key attr-name">rocketmq.producer.group</span><span class="token punctuation">=</span><span class="token value attr-value">tanhua</span>

<span class="token comment"># mongodb相关配置</span>
<span class="token key attr-name">spring.data.mongodb.username</span><span class="token punctuation">=</span><span class="token value attr-value">tanhua</span>
<span class="token key attr-name">spring.data.mongodb.password</span><span class="token punctuation">=</span><span class="token value attr-value">l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV</span>
<span class="token key attr-name">spring.data.mongodb.authentication-database</span><span class="token punctuation">=</span><span class="token value attr-value">admin</span>
<span class="token key attr-name">spring.data.mongodb.database</span><span class="token punctuation">=</span><span class="token value attr-value">tanhua</span>
<span class="token key attr-name">spring.data.mongodb.port</span><span class="token punctuation">=</span><span class="token value attr-value">27017</span>
<span class="token key attr-name">spring.data.mongodb.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.31.81</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-3、启动类" tabindex="-1"><a class="header-anchor" href="#_3-5-3、启动类" aria-hidden="true">#</a> 3.5.3、启动类</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecommendApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">RecommendApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-4、recommendquanzi" tabindex="-1"><a class="header-anchor" href="#_3-5-4、recommendquanzi" aria-hidden="true">#</a> 3.5.4、RecommendQuanZi</h4><p>存储到MongoDB的中的实体结构。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">ObjectId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>collection <span class="token operator">=</span> <span class="token string">&quot;recommend_quanzi&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecommendQuanZi</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ObjectId</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token comment">// 用户id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> publishId<span class="token punctuation">;</span> <span class="token comment">//动态id，需要转化为Long类型</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> score<span class="token punctuation">;</span> <span class="token comment">//得分</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> date<span class="token punctuation">;</span> <span class="token comment">//时间戳</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-5、quanzimsgconsumer" tabindex="-1"><a class="header-anchor" href="#_3-5-5、quanzimsgconsumer" aria-hidden="true">#</a> 3.5.5、QuanZiMsgConsumer</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend<span class="token punctuation">.</span>msg</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">CollUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Publish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">RecommendQuanZi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">ObjectId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MongoTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;tanhua-quanzi&quot;</span><span class="token punctuation">,</span>
        consumerGroup <span class="token operator">=</span> <span class="token string">&quot;tanhua-quanzi-consumer&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuanZiMsgConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Long</span> userId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> date <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> publishId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> pid <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;pid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> type <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">RecommendQuanZi</span> recommendQuanZi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecommendQuanZi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendQuanZi<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendQuanZi<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendQuanZi<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendQuanZi<span class="token punctuation">.</span><span class="token function">setPublishId</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//1-发动态，2-浏览动态， 3-点赞， 4-喜欢， 5-评论，6-取消点赞，7-取消喜欢</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>

                    <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Publish</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>publish<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">double</span> score <span class="token operator">=</span> <span class="token number">0d</span><span class="token punctuation">;</span>

                        <span class="token comment">//获取图片数</span>
                        score <span class="token operator">+=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getMedias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">//获取文本的长度</span>
                        <span class="token comment">//文字长度：50以内1分，50~100之间2分，100以上3分</span>
                        <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> length <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            score <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            score <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            score <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">1d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">8d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">10d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">8d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendQuanZi<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>

            <span class="token comment">//数据保存到MongoDB中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>recommendQuanZi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理消息出错！msg = &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-7、测试" tabindex="-1"><a class="header-anchor" href="#_1-7、测试" aria-hidden="true">#</a> 1.7、测试</h3><p>测试方法：使用APP进行操作，可以看到在MongoDB中已经有数据写入。</p><p><img src="/vuepress-java/assets/image-20210126160159662.2c88ece2.png" alt="image-20210126160159662"></p><h2 id="_4、部署推荐系统" tabindex="-1"><a class="header-anchor" href="#_4、部署推荐系统" aria-hidden="true">#</a> 4、部署推荐系统</h2><p>在推荐系统中，我们将基于前面写入到推荐表中的数据通过Spark进行计算，在Spark计算完成后将结果写入到Redis中，以供在业务系统中进行查询。</p><p>推荐服务我们将基于docker的形式进行部署：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#拉取镜像</span>
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-quanzi:1.0

<span class="token comment">#创建容器</span>
<span class="token function">docker</span> create <span class="token parameter variable">--name</span> tanhua-spark-quanzi <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_HOST</span><span class="token operator">=</span><span class="token number">192.168</span>.31.81 <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_PORT</span><span class="token operator">=</span><span class="token number">27017</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_USERNAME</span><span class="token operator">=</span>tanhua <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_PASSWORD</span><span class="token operator">=</span>l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_DATABASE</span><span class="token operator">=</span>tanhua <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_COLLECTION</span><span class="token operator">=</span>recommend_quanzi <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">SCHEDULE_PERIOD</span><span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">REDIS_NODES</span><span class="token operator">=</span><span class="token string">&quot;192.168.31.81:6379,192.168.31.81:6380,192.168.31.81:6381&quot;</span> <span class="token punctuation">\</span>
registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-quanzi:1.0

<span class="token comment">#参数说明</span>
<span class="token comment">#MONGODB_HOST mongodb服务的地址</span>
<span class="token comment">#MONGODB_PORT mongodb服务的端口</span>
<span class="token comment">#MONGODB_USERNAME mongodb服务的认证用户名</span>
<span class="token comment">#MONGODB_PASSWORD mongodb服务的认证密码</span>
<span class="token comment">#MONGODB_DATABASE mongodb连接的数据库</span>
<span class="token comment">#MONGODB_COLLECTION 操作表</span>
<span class="token comment">#SCHEDULE_PERIOD  下次执行时间间隔，但是为分，默认为10分钟</span>
<span class="token comment">#REDIS_NODES  redis集群地址，也可以使用单节点</span>

<span class="token comment">#mongodb开启认证服务</span>
<span class="token comment">#docker create --name mongodb --restart=always -p 27017:27017 -v mongodb:/data/db mongo:4.0.3 --auth</span>

<span class="token comment">#启动服务，启动之后就会进行执行，在SCHEDULE_PERIOD时间后再次执行</span>
<span class="token function">docker</span> start tanhua-spark-quanzi

<span class="token comment">#查看日志</span>
<span class="token function">docker</span> logs <span class="token parameter variable">-f</span> tanhua-spark-quanzi

<span class="token comment">#执行完成后会将数据写入到redis中</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入redis查看是否已经有数据： <img src="/vuepress-java/assets/image-20200821104559656.6ab70c81.png" alt="image-20200821104559656"></p><h2 id="_5、小视频推荐" tabindex="-1"><a class="header-anchor" href="#_5、小视频推荐" aria-hidden="true">#</a> 5、小视频推荐</h2><p>小视频的推荐和动态推荐的实现逻辑非常的类似。</p><h3 id="_5-1、动态计分规则" tabindex="-1"><a class="header-anchor" href="#_5-1、动态计分规则" aria-hidden="true">#</a> 5.1、动态计分规则</h3><ul><li>发布+2</li><li>点赞 +5</li><li>评论 + 10</li></ul><h3 id="_5-2、发送消息" tabindex="-1"><a class="header-anchor" href="#_5-2、发送消息" aria-hidden="true">#</a> 5.2、发送消息</h3><h4 id="_5-2-1、videomqservice" tabindex="-1"><a class="header-anchor" href="#_5-2-1、videomqservice" aria-hidden="true">#</a> 5.2.1、VideoMQService</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserThreadLocal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">VideoApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoMQService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">VideoApi</span> videoApi<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 发布小视频消息
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">videoMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 点赞小视频
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">likeVideoMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 取消点赞小视频
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">disLikeVideoMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 评论小视频
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">commentVideoMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 发送小视频操作相关的消息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">videoId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">type</span>     1-发动态，2-点赞， 3-取消点赞，4-评论
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Video</span> video <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">queryVideoById</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//构建消息</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;videoId&quot;</span><span class="token punctuation">,</span> videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;vid&quot;</span><span class="token punctuation">,</span> video<span class="token punctuation">.</span><span class="token function">getVid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;tanhua-video&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败! videoId = &quot;</span> <span class="token operator">+</span> videoId <span class="token operator">+</span> <span class="token string">&quot;, type = &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-2、videoservice" tabindex="-1"><a class="header-anchor" href="#_4-3-2、videoservice" aria-hidden="true">#</a> 4.3.2、VideoService</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">CollUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>conn<span class="token punctuation">.</span></span><span class="token class-name">FdfsWebServer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>fdfs<span class="token punctuation">.</span></span><span class="token class-name">StorePath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FastFileStorageClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">UserInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PicUploadService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserThreadLocal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PicUploadResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">QuanZiApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">VideoApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">VideoVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">VideoApi</span> videoApi<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PicUploadService</span> picUploadService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">protected</span> <span class="token class-name">FastFileStorageClient</span> storageClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FdfsWebServer</span> fdfsWebServer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfoService</span> userInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanZiApi</span> quanZiApi<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanZiService</span> quanZiService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">VideoMQService</span> videoMQService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 小视频上传
     *
     * <span class="token keyword">@param</span> <span class="token parameter">picFile</span>   封面图片
     * <span class="token keyword">@param</span> <span class="token parameter">videoFile</span> 视频文件
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">saveVideo</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> picFile<span class="token punctuation">,</span> <span class="token class-name">MultipartFile</span> videoFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Video</span> video <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        video<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        video<span class="token punctuation">.</span><span class="token function">setSeeType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//上传图片到阿里云oss</span>
            <span class="token class-name">PicUploadResult</span> uploadResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>picUploadService<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>picFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            video<span class="token punctuation">.</span><span class="token function">setPicUrl</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//上传视频到FastDFS中</span>
            <span class="token class-name">StorePath</span> storePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storageClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>videoFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    videoFile<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">subAfter</span><span class="token punctuation">(</span>videoFile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            video<span class="token punctuation">.</span><span class="token function">setVideoUrl</span><span class="token punctuation">(</span>fdfsWebServer<span class="token punctuation">.</span><span class="token function">getWebServerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> storePath<span class="token punctuation">.</span><span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token class-name">String</span> videoId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">saveVideo</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//发送消息</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>videoMQService<span class="token punctuation">.</span><span class="token function">videoMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;上传小视频出错~ userId = &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, file = &quot;</span> <span class="token operator">+</span> videoFile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">queryVideoList</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//查询用户信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userInfoService<span class="token punctuation">.</span><span class="token function">queryUserInfoByUserIdList</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VideoVo</span><span class="token punctuation">&gt;</span></span> videoVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Video</span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">VideoVo</span> videoVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VideoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            videoVo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setCover</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getPicUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setVideoUrl</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getVideoUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setSignature</span><span class="token punctuation">(</span><span class="token string">&quot;我就是我~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO 签名</span>

            videoVo<span class="token punctuation">.</span><span class="token function">setCommentCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryCommentCount</span><span class="token punctuation">(</span>videoVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//评论数</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setHasFocus</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">isFollowUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> videoVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是否关注</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> videoVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是否点赞（1是，0否）</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>videoVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//点赞数</span>

            <span class="token comment">//填充用户信息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo <span class="token operator">:</span> userInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>videoVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    videoVo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    videoVo<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            videoVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>videoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>videoVoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 点赞
     *
     * <span class="token keyword">@param</span> <span class="token parameter">videoId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">likeComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">//发送消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>videoMQService<span class="token punctuation">.</span><span class="token function">likeVideoMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 取消点赞
     *
     * <span class="token keyword">@param</span> <span class="token parameter">videoId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">disLikeComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">//发送消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>videoMQService<span class="token punctuation">.</span><span class="token function">disLikeVideoMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">saveComments</span><span class="token punctuation">(</span>videoId<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//发送消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>videoMQService<span class="token punctuation">.</span><span class="token function">commentVideoMsg</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryCommentList</span><span class="token punctuation">(</span><span class="token class-name">String</span> videoId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">queryCommentList</span><span class="token punctuation">(</span>videoId<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 关注用户
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">followUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">followUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 取消关注
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">disFollowUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">disFollowUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3、接收消息" tabindex="-1"><a class="header-anchor" href="#_5-3、接收消息" aria-hidden="true">#</a> 5.3、接收消息</h3><h4 id="_5-3-1、recommendvideo" tabindex="-1"><a class="header-anchor" href="#_5-3-1、recommendvideo" aria-hidden="true">#</a> 5.3.1、RecommendVideo</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">ObjectId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>collection <span class="token operator">=</span> <span class="token string">&quot;recommend_video&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecommendVideo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ObjectId</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token comment">// 用户id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> videoId<span class="token punctuation">;</span> <span class="token comment">//视频id，需要转化为Long类型</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> score<span class="token punctuation">;</span> <span class="token comment">//得分</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> date<span class="token punctuation">;</span> <span class="token comment">//时间戳</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2、videomsgconsumer" tabindex="-1"><a class="header-anchor" href="#_5-3-2、videomsgconsumer" aria-hidden="true">#</a> 5.3.2、VideoMsgConsumer</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend<span class="token punctuation">.</span>msg</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>recommend<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">RecommendVideo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">ObjectId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MongoTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;tanhua-video&quot;</span><span class="token punctuation">,</span>
        consumerGroup <span class="token operator">=</span> <span class="token string">&quot;tanhua-video-consumer&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoMsgConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> userId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> vid <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;vid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> type <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//1-发动态，2-点赞， 3-取消点赞，4-评论</span>
            <span class="token class-name">RecommendVideo</span> recommendVideo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecommendVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendVideo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendVideo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendVideo<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            recommendVideo<span class="token punctuation">.</span><span class="token function">setVideoId</span><span class="token punctuation">(</span>vid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendVideo<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendVideo<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendVideo<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendVideo<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">10d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    recommendVideo<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>recommendVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理小视频消息失败~&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-3、测试" tabindex="-1"><a class="header-anchor" href="#_5-3-3、测试" aria-hidden="true">#</a> 5.3.3、测试</h4><p><img src="/vuepress-java/assets/image-20210126172911927.655374cd.png" alt="image-20210126172911927"></p><p>可以看到，用户1对于视频有点赞、取消点赞、评论等操作。</p><h3 id="_5-4、部署推荐服务" tabindex="-1"><a class="header-anchor" href="#_5-4、部署推荐服务" aria-hidden="true">#</a> 5.4、部署推荐服务</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#拉取镜像</span>
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-video:1.0

<span class="token comment">#创建容器</span>
<span class="token function">docker</span> create <span class="token parameter variable">--name</span> tanhua-spark-video <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_HOST</span><span class="token operator">=</span><span class="token number">192.168</span>.31.81 <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_PORT</span><span class="token operator">=</span><span class="token number">27017</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_USERNAME</span><span class="token operator">=</span>tanhua <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_PASSWORD</span><span class="token operator">=</span>l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_DATABASE</span><span class="token operator">=</span>tanhua <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">MONGODB_COLLECTION</span><span class="token operator">=</span>recommend_video <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">SCHEDULE_PERIOD</span><span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--env</span> <span class="token assign-left variable">REDIS_NODES</span><span class="token operator">=</span><span class="token string">&quot;192.168.31.81:6379,192.168.31.81:6380,192.168.31.81:6381&quot;</span> <span class="token punctuation">\</span>
registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-video:1.0

<span class="token comment">#启动服务</span>
<span class="token function">docker</span> start tanhua-spark-video

<span class="token comment">#查看日志</span>
<span class="token function">docker</span> logs <span class="token parameter variable">-f</span> tanhua-spark-video
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：</p><p><img src="/vuepress-java/assets/1570452212069.6dcacfac.png" alt="1570452212069"></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">最近更新时间: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">作者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 2279345175@qq.com">橘橙天下</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/vuepress-java/assets/app.3c40b068.js" defer></script>
  </body>
</html>
