import{_ as n,o as s,c as a,b as p}from"./app.32912d8e.js";const t="/vuepress-java/assets/image-20201218153502042.6a7fbc1c.png",e="/vuepress-java/assets/image-20201218161505609.d27d6606.png",o="/vuepress-java/assets/image-20201218161521081.bb0b6f0a.png",c="/vuepress-java/assets/image-20201221105505538.1322eb1a.png",i="/vuepress-java/assets/image-20201221114335332.4b3b923a.png",l="/vuepress-java/assets/image-20201221114927609.63e3cc8a.png",u="/vuepress-java/assets/image-20201221214045637.fd16e73f.png",k="/vuepress-java/assets/image-20201222115831760.db5a810e.png",r="/vuepress-java/assets/image-20201222120513728.c1927ed2.png",d="/vuepress-java/assets/1568878011614.eb609263.png",m="/vuepress-java/assets/1568878327076.c88dc736.png",v="/vuepress-java/assets/1568878353854.2a5d7d30.png",b="/vuepress-java/assets/1568878397710.75f34d0c.png",g="/vuepress-java/assets/6bd41a6af1fef5cc89dda7c94208c6a64f3.d8cc4edf.png",y="/vuepress-java/assets/1746338-20190925190927228-1815093216.1a4ac71a.png",h="/vuepress-java/assets/b3d48e8fd6255834f2445e0b956390455a4.4a768d4a.png",f="/vuepress-java/assets/image-20201222171613466.a1341467.png",w="/vuepress-java/assets/image-20201224231912916.34941979.png",I="/vuepress-java/assets/image-20201222212229360.f4b3ed0d.png",S="/vuepress-java/assets/1569075180126.7afca3e0.png",q="/vuepress-java/assets/image-20201222214127912.4e62876b.png",C="/vuepress-java/assets/image-20201222214313987.fcb1f683.png",_="/vuepress-java/assets/image-20201222224514603.4d28696b.png",L="/vuepress-java/assets/image-20201222234918988.a2d33f54.png",j="/vuepress-java/assets/image-20201222234936528.184a8bc0.png",R="/vuepress-java/assets/image-20201222235041124.5890574f.png",V={},T=p('<h2 id="\u8BFE\u7A0B\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#\u8BFE\u7A0B\u8BF4\u660E" aria-hidden="true">#</a> \u8BFE\u7A0B\u8BF4\u660E</h2><ul><li>\u5708\u5B50\u5B9E\u73B0\u70B9\u8D5E\u3001\u559C\u6B22\u529F\u80FD</li><li>\u5708\u5B50\u5B9E\u73B0\u8BC4\u8BBA</li><li>\u5708\u5B50\u5B9E\u73B0\u8BC4\u8BBA\u7684\u70B9\u8D5E</li><li>\u5C0F\u89C6\u9891\u529F\u80FD\u4ECB\u7ECD</li><li>FastDFS\u5165\u95E8\u5B66\u4E60</li><li>\u5B9E\u73B0\u53D1\u5E03\u5C0F\u89C6\u9891\u529F\u80FD</li><li>\u5B9E\u73B0\u67E5\u8BE2\u5C0F\u89C6\u9891\u5217\u8868\u529F\u80FD</li></ul><h2 id="_1\u3001\u5708\u5B50\u70B9\u8D5E\u5B9E\u73B0\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#_1\u3001\u5708\u5B50\u70B9\u8D5E\u5B9E\u73B0\u5206\u6790" aria-hidden="true">#</a> 1\u3001\u5708\u5B50\u70B9\u8D5E\u5B9E\u73B0\u5206\u6790</h2><p>\u5728\u5708\u5B50\u529F\u80FD\u4E2D\uFF0C\u5BF9\u4E8E\u5708\u5B50\u7684\u70B9\u8D5E\u3001\u559C\u6B22\u3001\u8BC4\u8BBA\u7B49\u5747\u53EF\u7406\u89E3\u4E3A\u7528\u6237\u5BF9\u52A8\u6001\u7684\u8BC4\u8BBA\uFF08Comment\uFF09\uFF0C\u5728quanzi_comment\u8868\u4E2D\u4F7F\u7528commentType\u8FDB\u884C\u533A\u5206\u3002</p><p>\u5728\u5177\u4F53\u7684\u5B9E\u73B0\u4E2D\uFF0C\u9700\u8981\u5C06\u70B9\u8D5E\u6570\u3001\u67D0\u7528\u6237\u662F\u5426\u70B9\u8D5E\u7B49\u6570\u636E\u4FDD\u5B58\u5230Reds\u4E2D\uFF0C\u4EE5\u51CF\u8F7BMongoDB\u7684\u538B\u529B\u3002</p><p>\u5177\u4F53\u5B58\u50A8\u7ED3\u6784\u5982\u4E0B\uFF1A</p><p><img src="'+t+`" alt="image-20201218153502042"></p><blockquote><p>\u8BF4\u660E\uFF1A\u5728Redis\u7684\u5B58\u50A8\u7ED3\u6784\u4E2D\uFF0C\u91C7\u7528\u7684\u662FHash\u5B58\u50A8\uFF0C\u8FD9\u6837\u7684\u597D\u5904\u5C31\u5728\u4E8E\u4E00\u6761\u52A8\u6001\u7684\u70B9\u8D5E\u3001\u559C\u6B22\u7B49\u6570\u636E\u90FD\u4F1A\u96C6\u4E2D\u7684\u5B58\u50A8\u5230\u4E00\u8D77\uFF0C\u4ECE\u800C\u51CF\u5C11\u4E86Redis\u4E2D\u6570\u636E\u6761\u6570\u3002</p></blockquote><h2 id="_2\u3001\u70B9\u8D5E" tabindex="-1"><a class="header-anchor" href="#_2\u3001\u70B9\u8D5E" aria-hidden="true">#</a> 2\u3001\u70B9\u8D5E</h2><h3 id="_2-1\u3001\u5B9A\u4E49\u679A\u4E3E" tabindex="-1"><a class="header-anchor" href="#_2-1\u3001\u5B9A\u4E49\u679A\u4E3E" aria-hidden="true">#</a> 2.1\u3001\u5B9A\u4E49\u679A\u4E3E</h3><p>\u4E3A\u4E86\u89C4\u8303\u4F7F\u7528CommentType\uFF0C\u6240\u4EE5\u5C06\u5176\u5B9A\u4E49\u4E3A\u679A\u4E3E\u7C7B\u578B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>enums</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u8BC4\u8BBA\u7C7B\u578B\uFF1A1-\u70B9\u8D5E\uFF0C2-\u8BC4\u8BBA\uFF0C3-\u559C\u6B22
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">CommentType</span> <span class="token punctuation">{</span>

    <span class="token function">LIKE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">COMMENT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">LOVE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> type<span class="token punctuation">;</span>

    <span class="token class-name">CommentType</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2\u3001dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-2\u3001dubbo\u670D\u52A1" aria-hidden="true">#</a> 2.2\u3001dubbo\u670D\u52A1</h3><h4 id="_2-2-1\u3001\u5B9A\u4E49\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_2-2-1\u3001\u5B9A\u4E49\u63A5\u53E3" aria-hidden="true">#</a> 2.2.1\u3001\u5B9A\u4E49\u63A5\u53E3</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Publish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageInfo</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">QuanZiApi</span> <span class="token punctuation">{</span>

    <span class="token comment">//........\u6B64\u5904\u5FFD\u7565\u5176\u4ED6\u4EE3\u7801..........</span>

    <span class="token doc-comment comment">/**
     * \u6839\u636Eid\u67E5\u8BE2\u52A8\u6001
     *
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> \u52A8\u6001id
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Publish</span> <span class="token function">queryPublishById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u70B9\u8D5E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u53D6\u6D88\u70B9\u8D5E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u70B9\u8D5E\u6570
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Long</span> <span class="token function">queryLikeCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u7528\u6237\u662F\u5426\u70B9\u8D5E\u8BE5\u52A8\u6001
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">queryUserIsLike</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2\u3001\u7F16\u5199\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_2-2-2\u3001\u7F16\u5199\u5B9E\u73B0" aria-hidden="true">#</a> 2.2.2\u3001\u7F16\u5199\u5B9E\u73B0</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuanZiApiImpl</span> <span class="token keyword">implements</span> <span class="token class-name">QuanZiApi</span> <span class="token punctuation">{</span>

    <span class="token comment">//\u8BC4\u8BBA\u6570\u636E\u5B58\u50A8\u5728Redis\u4E2Dkey\u7684\u524D\u7F00</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COMMENT_REDIS_KEY_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;QUANZI_COMMENT_&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//\u7528\u6237\u662F\u5426\u70B9\u8D5E\u7684\u524D\u7F00</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COMMENT_USER_LIEK_REDIS_KEY_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;USER_LIKE_&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//\u7528\u6237\u662F\u5426\u559C\u6B22\u7684\u524D\u7F00</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COMMENT_USER_LOVE_REDIS_KEY_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;USER_LOVE_&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

   	<span class="token comment">//........\u6B64\u5904\u5FFD\u7565\u5176\u4ED6\u4EE3\u7801..........</span>

        <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Publish</span> <span class="token function">queryPublishById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Publish</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u5224\u65AD\u8BE5\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u70B9\u8D5E\uFF0C\u5982\u679C\u5DF2\u7ECF\u70B9\u8D5E\u5C31\u76F4\u63A5\u8FD4\u56DE</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u4FDD\u5B58Comment\u6570\u636E</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u4FEE\u6539redis\u4E2D\u7684\u70B9\u8D5E\u6570\u4EE5\u53CA\u662F\u5426\u70B9\u8D5E</span>

        <span class="token comment">//\u4FEE\u6539\u70B9\u8D5E\u6570</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u7528\u6237\u662F\u5426\u70B9\u8D5E</span>
        <span class="token class-name">String</span> userHashKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentUserLikeRedisKeyPrefix</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userHashKey<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">COMMENT_REDIS_KEY_PREFIX</span> <span class="token operator">+</span> publishId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCommentUserLikeRedisKeyPrefix</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">COMMENT_USER_LIKE_REDIS_KEY_PREFIX</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u5224\u65AD\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u70B9\u8D5E\uFF0C\u5982\u679C\u6CA1\u6709\u70B9\u8D5E\u5C31\u8FD4\u56DE</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u5220\u9664\u8BC4\u8BBA\u6570\u636E</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u4FEE\u6539Redis\u4E2D\u7684\u6570\u636E</span>

        <span class="token comment">//\u4FEE\u6539\u70B9\u8D5E\u6570</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u7528\u6237\u662F\u5426\u70B9\u8D5E</span>
        <span class="token class-name">String</span> userHashKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentUserLikeRedisKeyPrefix</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">queryLikeCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4ECERedis\u4E2D\u547D\u4E2D\u67E5\u8BE2\uFF0C\u5982\u679C\u547D\u4E2D\u76F4\u63A5\u8FD4\u56DE\u5373\u53EF</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u67E5\u8BE2Mongodb</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryCommentCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5199\u5165Redis\u4E2D</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryUserIsLike</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4ECEredis\u4E2D\u67E5\u8BE2\u6570\u636E</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userHashKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentUserLikeRedisKeyPrefix</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userHashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u67E5\u8BE2Mongodb\uFF0C\u786E\u5B9A\u662F\u5426\u5DF2\u7ECF\u70B9\u8D5E</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;commentType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u5199\u5165\u5230redis\u4E2D</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userHashKey<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u4FDD\u5B58Comment
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">,</span>
                                <span class="token class-name">CommentType</span> commentType<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Comment</span> comment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setPublishId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8BC4\u8BBA\u7C7B\u578B</span>
            comment<span class="token punctuation">.</span><span class="token function">setCommentType</span><span class="token punctuation">(</span>commentType<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5185\u5BB9</span>
            comment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryPublishById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//TODO \u5176\u4ED6\u8BC4\u8BBA\u5BF9\u8C61\uFF0C\u6682\u4E0D\u5904\u7406</span>
            comment<span class="token punctuation">.</span><span class="token function">setPublishUserId</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u4FDD\u5B58Comment\u51FA\u9519~ userId = &quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;, publishId = &quot;</span> <span class="token operator">+</span> publishId <span class="token operator">+</span> <span class="token string">&quot;, commentType = &quot;</span> <span class="token operator">+</span> commentType<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u5220\u9664\u8BC4\u8BBA\u6570\u636E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">commentType</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">removeComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span> commentType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;commentType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>commentType<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeletedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u6570\u91CF
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">commentType</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token function">queryCommentCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span> commentType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;commentType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>commentType<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-3\u3001\u7F16\u5199\u6D4B\u8BD5\u7528\u4F8B" tabindex="-1"><a class="header-anchor" href="#_2-2-3\u3001\u7F16\u5199\u6D4B\u8BD5\u7528\u4F8B" aria-hidden="true">#</a> 2.2.3\u3001\u7F16\u5199\u6D4B\u8BD5\u7528\u4F8B</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Publish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestQuanZiApi</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanZiApi</span> quanZiApi<span class="token punctuation">;</span>

    <span class="token comment">//........\u6B64\u5904\u5FFD\u7565\u5176\u4ED6\u4EE3\u7801..........</span>
    
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> publishId <span class="token operator">=</span> <span class="token string">&quot;5fae53947e52992e78a3afb1&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">likeComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">disLikeComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3\u3001app\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-3\u3001app\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 2.3\u3001APP\u63A5\u53E3\u670D\u52A1</h3><p>\u70B9\u8D5E\u63A5\u53E3\u5730\u5740\uFF1Ahttps://mock-java.itheima.net/project/35/interface/api/707</p><p><img src="`+e+'" alt="image-20201218161505609"></p><p><img src="'+o+`" alt="image-20201218161521081"></p><p>\u4ECE\u63A5\u53E3\u6587\u6863\u6765\u770B\uFF0C\u70B9\u8D5E\u5B8C\u6210\u540E\u9700\u8981\u8FD4\u56DE\u70B9\u8D5E\u6570\u3002</p><h4 id="_2-3-1\u3001\u7F16\u5199\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-3-1\u3001\u7F16\u5199\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 2.3.1\u3001\u7F16\u5199\u63A5\u53E3\u670D\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.controller.QuanZiController</span>
	<span class="token doc-comment comment">/**
     * \u70B9\u8D5E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}/like&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> likeCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">likeComment</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>likeCount <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u53D6\u6D88\u70B9\u8D5E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}/dislike&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> likeCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">disLikeComment</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> likeCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2\u3001\u7F16\u5199\u670D\u52A1\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_2-3-2\u3001\u7F16\u5199\u670D\u52A1\u5B9E\u73B0" aria-hidden="true">#</a> 2.3.2\u3001\u7F16\u5199\u670D\u52A1\u5B9E\u73B0</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.service.QuanZiService</span>

	<span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u70B9\u8D5E</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">likeComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u67E5\u8BE2\u70B9\u8D5E\u6570</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u53D6\u6D88\u70B9\u8D5E</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">disLikeComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u67E5\u8BE2\u70B9\u8D5E\u6570</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-3\u3001\u4FEE\u6539\u67E5\u8BE2\u52A8\u6001\u70B9\u8D5E\u6570" tabindex="-1"><a class="header-anchor" href="#_2-3-3\u3001\u4FEE\u6539\u67E5\u8BE2\u52A8\u6001\u70B9\u8D5E\u6570" aria-hidden="true">#</a> 2.3.3\u3001\u4FEE\u6539\u67E5\u8BE2\u52A8\u6001\u70B9\u8D5E\u6570</h4><p>\u67E5\u8BE2\u70B9\u8D5E\u6570\u3001\u662F\u5426\u70B9\u8D5E\uFF0C\u9700\u8981\u901A\u8FC7dubbo\u670D\u52A1\u8FDB\u884C\u67E5\u8BE2\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.service.QuanZiService</span>
    <span class="token doc-comment comment">/**
     * \u586B\u5145\u7528\u6237\u4FE1\u606F
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userInfo</span>
     * <span class="token keyword">@param</span> <span class="token parameter">quanZiVo</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillUserInfoToQuanZiVo</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">,</span> <span class="token class-name">QuanZiVo</span> quanZiVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> quanZiVo<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u5F53\u524D\u7528\u6237</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        quanZiVo<span class="token punctuation">.</span><span class="token function">setCommentCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u8BC4\u8BBA\u6570</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span><span class="token string">&quot;1.2\u516C\u91CC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u8DDD\u79BB</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u662F\u5426\u70B9\u8D5E\uFF081\u662F\uFF0C0\u5426\uFF09</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u70B9\u8D5E\u6570</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setHasLoved</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u662F\u5426\u559C\u6B22\uFF081\u662F\uFF0C0\u5426\uFF09</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setLoveCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u559C\u6B22\u6570</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-4\u3001\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_2-3-4\u3001\u6D4B\u8BD5" aria-hidden="true">#</a> 2.3.4\u3001\u6D4B\u8BD5</h4><p><img src="`+c+`" alt="image-20201221105505538"></p><p>\u4ECE\u6D4B\u8BD5\u7ED3\u679C\u4E2D\u53EF\u4EE5\u770B\u51FA\uFF0C\u5728\u54CD\u5E94\u7ED3\u679C\u4E2D\u8FD4\u56DE\u4E86\u70B9\u8D5E\u6570\u4EE5\u53CA\u662F\u5426\u70B9\u8D5E\u7684\u6570\u636E\u3002</p><h2 id="_3\u3001\u559C\u6B22" tabindex="-1"><a class="header-anchor" href="#_3\u3001\u559C\u6B22" aria-hidden="true">#</a> 3\u3001\u559C\u6B22</h2><p>\u559C\u6B22\u7684\u5B9E\u73B0\u4E0E\u70B9\u8D5E\u7C7B\u4F3C\uFF0C\u53EA\u662F\u5176\u7C7B\u578B\u4E0D\u540C\u3002\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u5728\u63A8\u8350\u52A8\u6001\u4E2D\u624D\u6709\u559C\u6B22\u529F\u80FD\uFF0C\u597D\u53CB\u52A8\u6001\u4E2D\u662F\u6CA1\u6709\u6B64\u529F\u80FD\u7684\u3002</p><h3 id="_3-1\u3001dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-1\u3001dubbo\u670D\u52A1" aria-hidden="true">#</a> 3.1\u3001dubbo\u670D\u52A1</h3><h4 id="_3-1-1\u3001\u5B9A\u4E49\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_3-1-1\u3001\u5B9A\u4E49\u63A5\u53E3" aria-hidden="true">#</a> 3.1.1\u3001\u5B9A\u4E49\u63A5\u53E3</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.dubbo.server.api.QuanZiApi</span>

	<span class="token doc-comment comment">/**
     * \u559C\u6B22
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">loveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u53D6\u6D88\u559C\u6B22
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">disLoveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u559C\u6B22\u6570
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Long</span> <span class="token function">queryLoveCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u7528\u6237\u662F\u5426\u559C\u6B22\u8BE5\u52A8\u6001
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">queryUserIsLove</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-2\u3001\u7F16\u5199\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_3-1-2\u3001\u7F16\u5199\u5B9E\u73B0" aria-hidden="true">#</a> 3.1.2\u3001\u7F16\u5199\u5B9E\u73B0</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.dubbo.server.api.QuanZiApiImpl</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">loveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u67E5\u8BE2\u8BE5\u7528\u6237\u662F\u5426\u5DF2\u7ECF\u559C\u6B22</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryUserIsLove</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u559C\u6B22</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u559C\u6B22\u6210\u529F\u540E\uFF0C\u4FEE\u6539Redis\u4E2D\u7684\u603B\u7684\u559C\u6B22\u6570</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u6807\u8BB0\u7528\u6237\u5DF2\u7ECF\u559C\u6B22</span>
        hashKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentUserLoveRedisKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCommentUserLoveRedisKey</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">COMMENT_USER_LOVE_REDIS_KEY_PREFIX</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">disLoveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryUserIsLove</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5982\u679C\u7528\u6237\u6CA1\u6709\u559C\u6B22\uFF0C\u5C31\u76F4\u63A5\u8FD4\u56DE</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5220\u9664\u5931\u8D25</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u5220\u9664redis\u4E2D\u7684\u8BB0\u5F55</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentUserLoveRedisKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">queryLoveCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u9996\u5148\u4ECEredis\u4E2D\u547D\u4E2D\uFF0C\u5982\u679C\u547D\u4E2D\u7684\u8BDD\u5C31\u8FD4\u56DE\uFF0C\u6CA1\u6709\u547D\u4E2D\u5C31\u67E5\u8BE2Mongodb</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u67E5\u8BE2count</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryCommentCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u5B58\u50A8\u5230redis\u4E2D</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryUserIsLove</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentRedisKeyPrefix</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hashKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommentUserLoveRedisKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u67E5\u8BE2mongodb</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;commentType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">LOVE</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u6807\u8BB0\u7528\u6237\u5DF2\u7ECF\u559C\u6B22</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> hashKey<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2\u3001app\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-2\u3001app\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 3.2\u3001APP\u63A5\u53E3\u670D\u52A1</h3><h4 id="_3-2-1\u3001\u7F16\u5199\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-2-1\u3001\u7F16\u5199\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 3.2.1\u3001\u7F16\u5199\u63A5\u53E3\u670D\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.controller.QuanZiController</span>

    <span class="token doc-comment comment">/**
     * \u559C\u6B22
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}/love&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">loveComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> loveCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">loveComment</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> loveCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>loveCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u53D6\u6D88\u559C\u6B22
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}/unlove&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">disLoveComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> loveCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">disLoveComment</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> loveCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>loveCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2\u3001\u7F16\u5199\u670D\u52A1\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_3-2-2\u3001\u7F16\u5199\u670D\u52A1\u5B9E\u73B0" aria-hidden="true">#</a> 3.2.2\u3001\u7F16\u5199\u670D\u52A1\u5B9E\u73B0</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.service.QuanZiService</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">loveComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u559C\u6B22</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">loveComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u67E5\u8BE2\u559C\u6B22\u6570</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLoveCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">disLoveComment</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u53D6\u6D88\u559C\u6B22</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">disLoveComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u67E5\u8BE2\u559C\u6B22\u6570</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLoveCount</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u586B\u5145\u7528\u6237\u4FE1\u606F
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userInfo</span>
     * <span class="token keyword">@param</span> <span class="token parameter">quanZiVo</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillUserInfoToQuanZiVo</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">,</span> <span class="token class-name">QuanZiVo</span> quanZiVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> quanZiVo<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u5F53\u524D\u7528\u6237</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        quanZiVo<span class="token punctuation">.</span><span class="token function">setCommentCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u8BC4\u8BBA\u6570</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span><span class="token string">&quot;1.2\u516C\u91CC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u8DDD\u79BB</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u662F\u5426\u70B9\u8D5E\uFF081\u662F\uFF0C0\u5426\uFF09</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u70B9\u8D5E\u6570</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setHasLoved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLove</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u662F\u5426\u559C\u6B22\uFF081\u662F\uFF0C0\u5426\uFF09</span>
        quanZiVo<span class="token punctuation">.</span><span class="token function">setLoveCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLoveCount</span><span class="token punctuation">(</span>quanZiVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u559C\u6B22\u6570</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-3\u3001\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_1-2-3\u3001\u6D4B\u8BD5" aria-hidden="true">#</a> 1.2.3\u3001\u6D4B\u8BD5</h4><p><img src="`+i+'" alt="image-20201221114335332"></p><h2 id="_4\u3001\u67E5\u8BE2\u5355\u6761\u52A8\u6001" tabindex="-1"><a class="header-anchor" href="#_4\u3001\u67E5\u8BE2\u5355\u6761\u52A8\u6001" aria-hidden="true">#</a> 4\u3001\u67E5\u8BE2\u5355\u6761\u52A8\u6001</h2><p>\u7528\u6237\u70B9\u51FB\u8BC4\u8BBA\u65F6\u9700\u8981\u67E5\u8BE2\u5355\u6761\u52A8\u6001\u8BE6\u60C5\uFF0C\u9700\u8981\u6709\u63A5\u53E3\u652F\u6301\u3002</p><p>\u670D\u52A1\u63A5\u53E3\u5730\u5740\uFF1Ahttps://mock-java.itheima.net/project/35/interface/api/695</p><p><img src="'+l+`" alt="image-20201221114927609"></p><p>\u54CD\u5E94\u7684\u6570\u636E\u63A5\u53E3\u4E0E\u67E5\u8BE2\u597D\u53CB\u52A8\u6001\u4E00\u81F4\uFF0C\u53EA\u662F\u5355\u6761\u8FD4\u56DE\u800C\u4E0D\u662F\u96C6\u5408\u3002</p><p>\u8981\u6CE8\u610F\u7684\u662F\uFF0Cdubbo\u670D\u52A1\u63A5\u53E3\u5728\u524D\u9762\u5DF2\u7ECF\u5F00\u53D1\u5B8C\u6210\uFF0C\u73B0\u5728\u53EA\u8981\u60F3\u5B9E\u73B0APP\u7AEF\u7684\u63A5\u53E3\u670D\u52A1\u5373\u53EF\u3002</p><h3 id="_4-1\u3001\u5B9A\u4E49\u670D\u52A1\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_4-1\u3001\u5B9A\u4E49\u670D\u52A1\u63A5\u53E3" aria-hidden="true">#</a> 4.1\u3001\u5B9A\u4E49\u670D\u52A1\u63A5\u53E3</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.controller.QuanZiController</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u5355\u6761\u52A8\u6001\u4FE1\u606F
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QuanZiVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">QuanZiVo</span> movements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> movements<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>movements<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2\u3001\u670D\u52A1\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-2\u3001\u670D\u52A1\u5B9E\u73B0" aria-hidden="true">#</a> 4.2\u3001\u670D\u52A1\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.service.QuanZiService</span>

	<span class="token keyword">public</span> <span class="token class-name">QuanZiVo</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryPublishById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>publish <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillQuanZiVo</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>publish<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3\u3001\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_4-3\u3001\u6D4B\u8BD5" aria-hidden="true">#</a> 4.3\u3001\u6D4B\u8BD5</h3><p><img src="`+u+`" alt="image-20201221214045637"></p><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u8FD4\u56DE\u4E86\u5355\u6761\u6570\u636E\u3002</p><h3 id="_4-4\u3001\u5F02\u5E38\u7684\u89E3\u51B3" tabindex="-1"><a class="header-anchor" href="#_4-4\u3001\u5F02\u5E38\u7684\u89E3\u51B3" aria-hidden="true">#</a> 4.4\u3001\u5F02\u5E38\u7684\u89E3\u51B3</h3><p>\u5728\u5B8C\u6210\u67E5\u8BE2\u5355\u6761\u52A8\u6001\u63A5\u53E3\u540E\uFF0C\u4F1A\u53D1\u73B0\uFF0C\u5237\u65B0\u9996\u9875\u65F6\u4F1A\u51FA\u73B0\u5982\u4E0B\u5F02\u5E38\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>java.lang.IllegalArgumentException: invalid hexadecimal representation of an ObjectId: <span class="token punctuation">[</span>visitors<span class="token punctuation">]</span>
	at org.bson.types.ObjectId.parseHexString<span class="token punctuation">(</span>ObjectId.java:550<span class="token punctuation">)</span>
	at org.bson.types.ObjectId.<span class="token operator">&lt;</span>init<span class="token operator">&gt;</span><span class="token punctuation">(</span>ObjectId.java:239<span class="token punctuation">)</span>
	at com.tanhua.dubbo.server.api.QuanZiApiImpl.queryPublishById<span class="token punctuation">(</span>QuanZiApiImpl.java:411<span class="token punctuation">)</span>
	at com.alibaba.dubbo.common.bytecode.Wrapper1.invokeMethod<span class="token punctuation">(</span>Wrapper1.java<span class="token punctuation">)</span>
	at com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory<span class="token variable">$1</span>.doInvoke<span class="token punctuation">(</span>JavassistProxyFactory.java:47<span class="token punctuation">)</span>
	at com.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker.invoke<span class="token punctuation">(</span>AbstractProxyInvoker.java:76<span class="token punctuation">)</span>
	at com.alibaba.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke<span class="token punctuation">(</span>DelegateProviderMetaDataInvoker.java:52<span class="token punctuation">)</span>
	at com.alibaba.dubbo.rpc.protocol.InvokerWrapper.invoke<span class="token punctuation">(</span>InvokerWrapper.java:56<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u539F\u56E0\u662F\uFF1A\u8C01\u770B\u8FC7\u6211\u7684\u63A5\u53E3\u8FD8\u6CA1\u5B9E\u73B0\uFF0C\u5BFC\u81F4\u4E86\u6620\u5C04\u5230\u4E86\u67E5\u8BE2\u5355\u6761\u52A8\u6001\u7684\u63A5\u53E3\uFF0C\u5BFC\u81F4\u7684\u5F02\u5E38\uFF0C\u63A5\u53E3\u5730\u5740\uFF1Ahttps://mock-java.itheima.net/project/35/interface/api/743</p><p>\u89E3\u51B3\u65B9\u6CD5\uFF1A\u7F16\u5199\u4E00\u4E2A\u7A7A\u7684\u65B9\u6CD5\u300A\u8C01\u770B\u8FC7\u6211\u300B\u7684\u63A5\u53E3\u5B9E\u73B0\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.controller.QuanZiController</span>
	<span class="token doc-comment comment">/**
     * TODO\uFF1A\u8C01\u770B\u8FC7\u6211
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;visitors&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryVisitors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token constant">EMPTY_LIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5\u3001\u8BC4\u8BBA" tabindex="-1"><a class="header-anchor" href="#_5\u3001\u8BC4\u8BBA" aria-hidden="true">#</a> 5\u3001\u8BC4\u8BBA</h2><p>\u5728\u5355\u6761\u52A8\u6001\u6253\u5F00\u540E\uFF0C\u53EF\u4EE5\u770B\u5230\u6709\u8BC4\u8BBA\u5217\u8868\uFF0C\u529F\u80FD\u5305\u62EC\uFF1A\u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868\uFF0C\u8BC4\u8BBA\u70B9\u8D5E\u3001\u53D6\u6D88\u70B9\u8D5E\u3002</p><p>\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u8BC4\u8BBA\u7684\u70B9\u8D5E\u64CD\u4F5C\u4E0E\u5708\u5B50\u52A8\u6001\u7684\u70B9\u8D5E\u4F7F\u7528\u540C\u4E00\u5957\u903B\u8F91\u3002</p><h3 id="_5-1\u3001dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_5-1\u3001dubbo\u670D\u52A1" aria-hidden="true">#</a> 5.1\u3001dubbo\u670D\u52A1</h3><h4 id="_5-1-1\u3001\u5B9A\u4E49\u670D\u52A1\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_5-1-1\u3001\u5B9A\u4E49\u670D\u52A1\u63A5\u53E3" aria-hidden="true">#</a> 5.1.1\u3001\u5B9A\u4E49\u670D\u52A1\u63A5\u53E3</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.dubbo.server.api.QuanZiApi</span>

	<span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u8BC4\u8BBA
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCommentList</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u53D1\u8868\u8BC4\u8BBA
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">content</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-2\u3001\u7F16\u5199\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_5-1-2\u3001\u7F16\u5199\u5B9E\u73B0" aria-hidden="true">#</a> 5.1.2\u3001\u7F16\u5199\u5B9E\u73B0</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868
     * 
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCommentList</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PageRequest</span> pageRequest <span class="token operator">=</span> <span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">Sort</span><span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Order</span><span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span>
                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;publishId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;commentType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> commentList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageInfo<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageInfo<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageInfo<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>commentList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u53D1\u8868\u8BC4\u8BBA
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">content</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> <span class="token class-name">CommentType</span><span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2\u3001app\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_5-2\u3001app\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 5.2\u3001APP\u63A5\u53E3\u670D\u52A1</h3><h4 id="_5-2-1\u3001commentvo" tabindex="-1"><a class="header-anchor" href="#_5-2-1\u3001commentvo" aria-hidden="true">#</a> 5.2.1\u3001CommentVo</h4><p>\u6839\u636E\u54CD\u5E94\u7ED3\u679C\u7684\u6570\u636E\u7ED3\u6784\u5B9A\u4E49\u5BF9\u8C61\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u8BC4\u8BBA
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommentVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span> <span class="token comment">//\u8BC4\u8BBAid</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar<span class="token punctuation">;</span> <span class="token comment">//\u5934\u50CF</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span> <span class="token comment">//\u6635\u79F0</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span> <span class="token comment">//\u8BC4\u8BBA</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> createDate<span class="token punctuation">;</span> <span class="token comment">//\u8BC4\u8BBA\u65F6\u95F4: 08:27</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> likeCount<span class="token punctuation">;</span> <span class="token comment">//\u70B9\u8D5E\u6570</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> hasLiked<span class="token punctuation">;</span> <span class="token comment">//\u662F\u5426\u70B9\u8D5E\uFF081\u662F\uFF0C0\u5426\uFF09</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-2\u3001\u7F16\u5199controller" tabindex="-1"><a class="header-anchor" href="#_5-2-2\u3001\u7F16\u5199controller" aria-hidden="true">#</a> 5.2.2\u3001\u7F16\u5199Controller</h4><p>\u5728APP\u63A5\u53E3\u670D\u52A1\u4E2D\uFF0C\u9700\u8981\u5F00\u53D14\u4E2A\u63A5\u53E3\uFF0C\u5206\u522B\u662F\u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868\u3001\u53D1\u8868\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u53D6\u6D88\u70B9\u8D5E\u3002</p><p>\u7531\u4E8E\u5176\u63A5\u53E3\u7684url\u5730\u5740\u4E0EQuanZiConroller\u5730\u5740\u4E0D\u540C\uFF0C\u6240\u4EE5\u9700\u8981\u521B\u5EFA\u4E0D\u540C\u7684Controller\u7C7B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">QuanZiService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * \u5708\u5B50\u529F\u80FD\u4E2D\u7684\u8BC4\u8BBA
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;comments&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuanZiCommentController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">QuanZiService</span> quanZiService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCommentsList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;movementId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span>
                                                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;pagesize&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">queryCommentList</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>pageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u4FDD\u5B58\u8BC4\u8BBA
     */</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveComments</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> publishId <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;movementId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">saveComments</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u70B9\u8D5E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;{id}/like&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">likeComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> likeCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">likeComment</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>likeCount <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u53D6\u6D88\u70B9\u8D5E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;{id}/dislike&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">disLikeComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> publishId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> likeCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiService<span class="token punctuation">.</span><span class="token function">disLikeComment</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> likeCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-3\u3001\u7F16\u5199service\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_5-2-3\u3001\u7F16\u5199service\u5B9E\u73B0" aria-hidden="true">#</a> 5.2.3\u3001\u7F16\u5199Service\u5B9E\u73B0</h4><p>Service\u7684\u5177\u4F53\u5B9E\u73B0\u4F9D\u7136\u662F\u653E\u5230QuanZiSerivce\u4E2D\u5B8C\u6210\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.service.QuanZiService</span>

   <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868
     *
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryCommentList</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u67E5\u8BE2\u8BC4\u8BBA\u5217\u8868\u6570\u636E</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryCommentList</span><span class="token punctuation">(</span>publishId<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u67E5\u8BE2\u7528\u6237\u4FE1\u606F</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userIdList <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userInfoService<span class="token punctuation">.</span><span class="token function">queryUserInfoByUserIdList</span><span class="token punctuation">(</span>userIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommentVo</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Comment</span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CommentVo</span> commentVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommentVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;HH:mm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u662F\u5426\u70B9\u8D5E</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryUserIsLike</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> commentVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u70B9\u8D5E\u6570</span>
            commentVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">queryLikeCount</span><span class="token punctuation">(</span>commentVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo <span class="token operator">:</span> userInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

                    commentVo<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    commentVo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>commentVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u53D1\u8868\u8BC4\u8BBA
     * <span class="token keyword">@param</span> <span class="token parameter">publishId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">content</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">saveComments</span><span class="token punctuation">(</span><span class="token class-name">String</span> publishId<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quanZiApi<span class="token punctuation">.</span><span class="token function">saveComment</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> publishId<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-4\u3001\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_5-2-4\u3001\u6D4B\u8BD5" aria-hidden="true">#</a> 5.2.4\u3001\u6D4B\u8BD5</h4><p><img src="`+k+`" alt="image-20201222115831760"></p><p>\u6D4B\u8BD5\u70B9\u8D5E\u65F6\u4F1A\u53D1\u73B0dubbo\u670D\u52A1\u4E2D\u4F1A\u51FA\u73B0null\u6307\u9488\u5F02\u5E38\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>java.lang.NullPointerException
	at com.tanhua.dubbo.server.api.QuanZiApiImpl.saveComment<span class="token punctuation">(</span>QuanZiApiImpl.java:386<span class="token punctuation">)</span>
	at com.tanhua.dubbo.server.api.QuanZiApiImpl.likeComment<span class="token punctuation">(</span>QuanZiApiImpl.java:180<span class="token punctuation">)</span>
	at com.alibaba.dubbo.common.bytecode.Wrapper1.invokeMethod<span class="token punctuation">(</span>Wrapper1.java<span class="token punctuation">)</span>
	at com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory<span class="token variable">$1</span>.doInvoke<span class="token punctuation">(</span>JavassistProxyFactory.java:47<span class="token punctuation">)</span>
	at com.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker.invoke<span class="token punctuation">(</span>AbstractProxyInvoker.java:76<span class="token punctuation">)</span>
	at com.alibaba.dubbo.config.invoker.DelegateProviderMetaDataInvoker.invoke<span class="token punctuation">(</span>DelegateProviderMetaDataInvoker.java:52<span class="token punctuation">)</span>
	at com.alibaba.dubbo.rpc.protocol.InvokerWrapper.invoke<span class="token punctuation">(</span>InvokerWrapper.java:56<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u539F\u56E0\u662F\uFF1A\u539F\u6709\u7684\u70B9\u8D5E\u5B9E\u73B0\u4E2D\uFF0C\u9700\u8981\u67E5\u8BE2Publish\u5BF9\u8C61\uFF0C\u4F46\u662F\u73B0\u5728\u5B9E\u73B0\u7684\u662F\u9488\u5BF9\u8BC4\u8BBA\u7684\u70B9\u8D5E\uFF0C\u662F\u67E5\u8BE2\u4E0D\u5230Publish\u5BF9\u8C61\u7684\uFF0C\u6240\u4EE5\u629B\u51FA\u4E86\u7A7A\u6307\u9488\u5F02\u5E38\u3002</p><p>\u89E3\u51B3\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.dubbo.server.api.QuanZiApiImpl</span>

    <span class="token doc-comment comment">/**
     * \u4FDD\u5B58Comment
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">saveComment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> publishId<span class="token punctuation">,</span>
                                <span class="token class-name">CommentType</span> commentType<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Comment</span> comment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setPublishId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8BC4\u8BBA\u7C7B\u578B</span>
            comment<span class="token punctuation">.</span><span class="token function">setCommentType</span><span class="token punctuation">(</span>commentType<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5185\u5BB9</span>
            comment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            comment<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Publish</span> publish <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryPublishById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>publish<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                comment<span class="token punctuation">.</span><span class="token function">setPublishUserId</span><span class="token punctuation">(</span>publish<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//\u67E5\u8BE2\u8BC4\u8BBA</span>
                <span class="token class-name">Comment</span> myComment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryCommentById</span><span class="token punctuation">(</span>publishId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>myComment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    comment<span class="token punctuation">.</span><span class="token function">setPublishUserId</span><span class="token punctuation">(</span>myComment<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">//TODO \u5176\u4ED6\u60C5\u51B5\uFF0C\u6BD4\u5982\u5C0F\u89C6\u9891\u7B49</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u4FDD\u5B58Comment\u51FA\u9519~ userId = &quot;</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">&quot;, publishId = &quot;</span> <span class="token operator">+</span> publishId <span class="token operator">+</span> <span class="token string">&quot;, commentType = &quot;</span> <span class="token operator">+</span> commentType<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u6839\u636Eid\u67E5\u8BE2Comment\u5BF9\u8C61
     *
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Comment</span> <span class="token function">queryCommentById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Comment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+r+'" alt="image-20201222120513728"></p><p>\u8FD9\u6837\uFF0C\u70B9\u8D5E\u529F\u80FD\u6B63\u5E38\u4E86\u3002</p><h2 id="_6\u3001\u5C0F\u89C6\u9891" tabindex="-1"><a class="header-anchor" href="#_6\u3001\u5C0F\u89C6\u9891" aria-hidden="true">#</a> 6\u3001\u5C0F\u89C6\u9891</h2><h3 id="_6-1\u3001\u529F\u80FD\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#_6-1\u3001\u529F\u80FD\u8BF4\u660E" aria-hidden="true">#</a> 6.1\u3001\u529F\u80FD\u8BF4\u660E</h3><p>\u5C0F\u89C6\u9891\u529F\u80FD\u7C7B\u4F3C\u4E8E\u6296\u97F3\u3001\u5FEB\u624B\u5C0F\u89C6\u9891\u7684\u5E94\u7528\uFF0C\u7528\u6237\u53EF\u4EE5\u4E0A\u4F20\u5C0F\u89C6\u9891\u8FDB\u884C\u5206\u4EAB\uFF0C\u4E5F\u53EF\u4EE5\u6D4F\u89C8\u67E5\u770B\u522B\u4EBA\u5206\u4EAB\u7684\u89C6\u9891\uFF0C\u5E76\u4E14\u53EF\u4EE5\u5BF9\u89C6\u9891\u8BC4\u8BBA\u548C\u70B9\u8D5E\u64CD\u4F5C\u3002</p><p>\u6548\u679C\uFF1A</p><p><img src="'+d+'" alt="1568878011614"></p><p>\u67E5\u770B\u8BE6\u60C5\uFF1A</p><p><img src="'+m+'" alt="1568878327076"></p><p>\u8BC4\u8BBA\uFF1A</p><p><img src="'+v+'" alt="1568878353854"></p><p>\u70B9\u8D5E\uFF1A</p><p><img src="'+b+'" alt="1568878397710"></p><h3 id="_6-2\u3001\u6280\u672F\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_6-2\u3001\u6280\u672F\u65B9\u6848" aria-hidden="true">#</a> 6.2\u3001\u6280\u672F\u65B9\u6848</h3><p>\u5BF9\u4E8E\u5C0F\u89C6\u9891\u7684\u529F\u80FD\u7684\u5F00\u53D1\uFF0C\u6838\u5FC3\u70B9\u5C31\u662F\uFF1A\u5B58\u50A8 + \u63A8\u8350 + \u52A0\u8F7D\u901F\u5EA6 \u3002</p><ul><li>\u5BF9\u4E8E\u5B58\u50A8\u800C\u8A00\uFF0C\u5C0F\u89C6\u9891\u7684\u5B58\u50A8\u91CF\u4EE5\u53CA\u5BB9\u91CF\u90FD\u662F\u975E\u5E38\u5DE8\u5927\u7684\u3002 <ul><li>\u6240\u4EE5\u6211\u4EEC\u9009\u62E9\u81EA\u5DF1\u642D\u5EFA\u5206\u5E03\u5F0F\u5B58\u50A8\u7CFB\u7EDF FastDFS\u8FDB\u884C\u5B58\u50A8\u3002</li></ul></li><li>\u5BF9\u4E8E\u63A8\u8350\u7B97\u6CD5\uFF0C\u6211\u4EEC\u5C06\u91C7\u7528\u591A\u79CD\u6743\u91CD\u7684\u8BA1\u7B97\u65B9\u5F0F\u8FDB\u884C\u8BA1\u7B97\u3002</li><li>\u5BF9\u4E8E\u52A0\u8F7D\u901F\u5EA6\uFF0C\u9664\u4E86\u63D0\u5347\u670D\u52A1\u5668\u5E26\u5BBD\u5916\u53EF\u4EE5\u901A\u8FC7CDN\u7684\u65B9\u5F0F\u8FDB\u884C\u52A0\u901F\uFF0C\u5F53\u7136\u4E86\u8FD9\u9700\u8981\u989D\u5916\u8D2D\u4E70CDN\u670D\u52A1\u3002</li></ul><h2 id="_7\u3001fastdfs" tabindex="-1"><a class="header-anchor" href="#_7\u3001fastdfs" aria-hidden="true">#</a> 7\u3001FastDFS</h2><h3 id="_7-1\u3001fastdfs\u662F\u4EC0\u4E48" tabindex="-1"><a class="header-anchor" href="#_7-1\u3001fastdfs\u662F\u4EC0\u4E48" aria-hidden="true">#</a> 7.1\u3001FastDFS\u662F\u4EC0\u4E48\uFF1F</h3><p>FastDFS\u662F\u5206\u5E03\u5F0F\u6587\u4EF6\u7CFB\u7EDF\u3002\u4F7F\u7528 FastDFS\u5F88\u5BB9\u6613\u642D\u5EFA\u4E00\u5957\u9AD8\u6027\u80FD\u7684\u6587\u4EF6\u670D\u52A1\u5668\u96C6\u7FA4\u63D0\u4F9B\u6587\u4EF6\u4E0A\u4F20\u3001\u4E0B\u8F7D\u7B49\u670D\u52A1\u3002</p><h3 id="_7-2\u3001\u5DE5\u4F5C\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#_7-2\u3001\u5DE5\u4F5C\u539F\u7406" aria-hidden="true">#</a> 7.2\u3001\u5DE5\u4F5C\u539F\u7406</h3><p>FastDFS \u67B6\u6784\u5305\u62EC Tracker server \u548C Storage server\u3002\u5BA2\u6237\u7AEF\u8BF7\u6C42 Tracker server \u8FDB\u884C\u6587\u4EF6\u4E0A\u4F20\u3001\u4E0B\u8F7D\uFF0C\u901A\u8FC7 Tracker server \u8C03\u5EA6\u6700\u7EC8\u7531 Storage server \u5B8C\u6210\u6587\u4EF6\u4E0A\u4F20\u548C\u4E0B\u8F7D\u3002</p><p>Tracker server \u4F5C\u7528\u662F\u8D1F\u8F7D\u5747\u8861\u548C\u8C03\u5EA6\uFF0C\u901A\u8FC7 Tracker server \u5728\u6587\u4EF6\u4E0A\u4F20\u65F6\u53EF\u4EE5\u6839\u636E\u4E00\u4E9B\u7B56\u7565\u627E\u5230 Storage server \u63D0\u4F9B\u6587\u4EF6\u4E0A\u4F20\u670D\u52A1\u3002\u53EF\u4EE5\u5C06 tracker \u79F0\u4E3A\u8FFD\u8E2A\u670D\u52A1\u5668\u6216\u8C03\u5EA6\u670D\u52A1\u5668\u3002</p><p>Storage server \u4F5C\u7528\u662F\u6587\u4EF6\u5B58\u50A8\uFF0C\u5BA2\u6237\u7AEF\u4E0A\u4F20\u7684\u6587\u4EF6\u6700\u7EC8\u5B58\u50A8\u5728 Storage \u670D\u52A1\u5668\u4E0A\uFF0CStorage server \u6CA1\u6709\u5B9E\u73B0\u81EA\u5DF1\u7684\u6587\u4EF6\u7CFB\u7EDF\u800C\u662F\u5229\u7528\u64CD\u4F5C\u7CFB\u7EDF\u7684\u6587\u4EF6\u7CFB\u7EDF\u6765\u7BA1\u7406\u6587\u4EF6\u3002\u53EF\u4EE5\u5C06storage\u79F0\u4E3A\u5B58\u50A8\u670D\u52A1\u5668\u3002</p><p><img src="'+g+'" alt="6bd41a6af1fef5cc89dda7c94208c6a64f3.png"></p><p>\u6BCF\u4E2A tracker \u8282\u70B9\u5730\u4F4D\u5E73\u7B49\uFF0C\u6536\u96C6 Storage \u96C6\u7FA4\u7684\u72B6\u6001\u3002</p><p>Storage \u5206\u4E3A\u591A\u4E2A\u7EC4\uFF0C\u6BCF\u4E2A\u7EC4\u4E4B\u95F4\u4FDD\u5B58\u7684\u6587\u4EF6\u662F\u4E0D\u540C\u7684\u3002\u6BCF\u4E2A\u7EC4\u5185\u90E8\u53EF\u4EE5\u6709\u591A\u4E2A\u6210\u5458\uFF0C\u7EC4\u6210\u5458\u5185\u90E8\u4FDD\u5B58\u7684\u5185\u5BB9\u662F\u4E00\u6837\u7684\uFF0C\u7EC4\u6210\u5458\u7684\u5730\u4F4D\u662F\u4E00\u81F4\u7684\uFF0C\u6CA1\u6709\u4E3B\u4ECE\u7684\u6982\u5FF5\u3002</p><h3 id="_7-3\u3001\u6587\u4EF6\u7684\u4E0A\u4F20" tabindex="-1"><a class="header-anchor" href="#_7-3\u3001\u6587\u4EF6\u7684\u4E0A\u4F20" aria-hidden="true">#</a> 7.3\u3001\u6587\u4EF6\u7684\u4E0A\u4F20</h3><p><img src="'+y+'" alt="1746338-20190925190927228-1815093216.png"></p><p>\u5BA2\u6237\u7AEF\u4E0A\u4F20\u6587\u4EF6\u540E\u5B58\u50A8\u670D\u52A1\u5668\u5C06\u6587\u4EF6 ID \u8FD4\u56DE\u7ED9\u5BA2\u6237\u7AEF\uFF0C\u6B64\u6587\u4EF6 ID \u7528\u4E8E\u4EE5\u540E\u8BBF\u95EE\u8BE5\u6587\u4EF6\u7684\u7D22\u5F15\u4FE1\u606F\u3002\u6587\u4EF6\u7D22\u5F15\u4FE1\u606F\u5305\u62EC\uFF1A\u7EC4\u540D\uFF0C\u865A\u62DF\u78C1\u76D8\u8DEF\u5F84\uFF0C\u6570\u636E\u4E24\u7EA7\u76EE\u5F55\uFF0C\u6587\u4EF6\u540D\u3002</p><h3 id="_7-4\u3001\u6587\u4EF6\u7684\u4E0B\u8F7D" tabindex="-1"><a class="header-anchor" href="#_7-4\u3001\u6587\u4EF6\u7684\u4E0B\u8F7D" aria-hidden="true">#</a> 7.4\u3001\u6587\u4EF6\u7684\u4E0B\u8F7D</h3><p><img src="'+h+`" alt="img"></p><p>\u5BA2\u6237\u7AEF\u4E0B\u8F7D\u8BF7\u6C42\u5230Tracker\u670D\u52A1\uFF0CTracker\u8FD4\u56DE\u7ED9\u5BA2\u6237\u7AEFstorage\u7684\u4FE1\u606F\uFF0C\u5BA2\u6237\u7AEF\u6839\u636E\u8FD9\u4E9B\u4FE1\u606F\u8FDB\u884C\u8BF7\u6C42storage\u83B7\u53D6\u5230\u6587\u4EF6\u3002</p><h3 id="_7-5\u3001\u5F00\u59CB\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#_7-5\u3001\u5F00\u59CB\u4F7F\u7528" aria-hidden="true">#</a> 7.5\u3001\u5F00\u59CB\u4F7F\u7528</h3><p>\u5728\u6211\u4EEC\u63D0\u4F9B\u7684\u865A\u62DF\u673A\u4E2D\u5DF2\u7ECF\u901A\u8FC7docker\u642D\u5EFA\u4E86FastDFS\u73AF\u5883\uFF0C\u4E0B\u9762\u6211\u4EEC\u6765\u5B66\u4E60\u4E0B\u5982\u4F55\u901A\u8FC7Java\u7A0B\u5E8F\u6765\u4F7F\u7528FastDFS\u3002</p><h4 id="_7-5-1\u3001\u5F15\u5165\u4F9D\u8D56" tabindex="-1"><a class="header-anchor" href="#_7-5-1\u3001\u5F15\u5165\u4F9D\u8D56" aria-hidden="true">#</a> 7.5.1\u3001\u5F15\u5165\u4F9D\u8D56</h4><p>\u5173\u4E8E\u4F7F\u7528FastDFS\u4E0A\u4F20\u5C0F\u89C6\u9891\u7684\u903B\u8F91\u6211\u4EEC\u5728server\u5DE5\u7A0B\u4E2D\u5B8C\u6210\uFF0C\u6240\u4EE5\u9700\u8981\u5728server\u5DE5\u7A0B\u4E2D\u5F15\u5165\u4F9D\u8D56\u3002</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.tobato<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.26.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>ch.qos.logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logback-classic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-2\u3001\u7F16\u5199\u914D\u7F6E\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_7-5-2\u3001\u7F16\u5199\u914D\u7F6E\u6587\u4EF6" aria-hidden="true">#</a> 7.5.2\u3001\u7F16\u5199\u914D\u7F6E\u6587\u4EF6</h4><p>\u5728application.properties\u914D\u7F6E\u6587\u4EF6\u4E2D\u52A0\u5165\u5982\u4E0B\u5185\u5BB9\uFF1A</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># ===================================================================</span>
<span class="token comment"># \u5206\u5E03\u5F0F\u6587\u4EF6\u7CFB\u7EDFFDFS\u914D\u7F6E</span>
<span class="token comment"># ===================================================================</span>
<span class="token key attr-name">fdfs.so-timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">1501</span>
<span class="token key attr-name">fdfs.connect-timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">601</span>
<span class="token comment">#\u7F29\u7565\u56FE\u751F\u6210\u53C2\u6570</span>
<span class="token key attr-name">fdfs.thumb-image.width</span><span class="token punctuation">=</span> <span class="token value attr-value">150</span>
<span class="token key attr-name">fdfs.thumb-image.height</span><span class="token punctuation">=</span> <span class="token value attr-value">150</span>
<span class="token comment">#TrackerList\u53C2\u6570,\u652F\u6301\u591A\u4E2A</span>
<span class="token key attr-name">fdfs.tracker-list</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.31.81:22122</span>
<span class="token comment">#\u8BBF\u95EE\u8DEF\u5F84</span>
<span class="token key attr-name">fdfs.web-server-url</span><span class="token punctuation">=</span><span class="token value attr-value">http://192.168.31.81:8888/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-5-3\u3001\u6D4B\u8BD5\u4EE3\u7801" tabindex="-1"><a class="header-anchor" href="#_7-5-3\u3001\u6D4B\u8BD5\u4EE3\u7801" aria-hidden="true">#</a> 7.5.3\u3001\u6D4B\u8BD5\u4EE3\u7801</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>conn<span class="token punctuation">.</span></span><span class="token class-name">FdfsWebServer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>fdfs<span class="token punctuation">.</span></span><span class="token class-name">StorePath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FastFileStorageClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFastDFS</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">protected</span> <span class="token class-name">FastFileStorageClient</span> storageClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FdfsWebServer</span> fdfsWebServer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">&quot;F:\\\\1.jpg&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">StorePath</span> storePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storageClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">openInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;jpg&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//StorePath [group=group1, path=M00/00/00/wKgfUV2GJSuAOUd_AAHnjh7KpOc1.1.jpg]</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fdfsWebServer<span class="token punctuation">.</span><span class="token function">getWebServerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> storePath<span class="token punctuation">.</span><span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//group1/M00/00/00/wKgfUV2GJSuAOUd_AAHnjh7KpOc1.1.jpg</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u901A\u8FC7\u6D4F\u89C8\u5668\u8BBF\u95EE\u56FE\u7247\uFF1A</p><p><img src="`+f+'" alt="image-20201222171613466"></p><h2 id="_8\u3001\u53D1\u5E03\u5C0F\u89C6\u9891" tabindex="-1"><a class="header-anchor" href="#_8\u3001\u53D1\u5E03\u5C0F\u89C6\u9891" aria-hidden="true">#</a> 8\u3001\u53D1\u5E03\u5C0F\u89C6\u9891</h2><p>\u53D1\u5E03\u5C0F\u89C6\u9891\u7684\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="'+w+`" alt="image-20201224231912916"></p><p>\u8BF4\u660E\uFF1A</p><ul><li>\u7528\u6237\u53D1\u901A\u8FC7\u5BA2\u6237\u7AEFAPP\u4E0A\u4F20\u89C6\u9891\u5230server\u670D\u52A1</li><li>server\u670D\u52A1\u4E0A\u4F20\u89C6\u9891\u5230FastDFS\u6587\u4EF6\u7CFB\u7EDF\uFF0C\u4E0A\u4F20\u6210\u529F\u540E\u8FD4\u56DE\u89C6\u9891\u7684url\u5730\u5740</li><li>server\u901A\u8FC7rpc\u7684\u8C03\u7528dubbo\u670D\u52A1\u8FDB\u884C\u4FDD\u5B58\u5C0F\u89C6\u9891\u6570\u636E</li></ul><h3 id="_8-1\u3001dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_8-1\u3001dubbo\u670D\u52A1" aria-hidden="true">#</a> 8.1\u3001dubbo\u670D\u52A1</h3><h4 id="_8-1-1\u3001\u7F16\u5199pojo" tabindex="-1"><a class="header-anchor" href="#_8-1-1\u3001\u7F16\u5199pojo" aria-hidden="true">#</a> 8.1.1\u3001\u7F16\u5199pojo</h4><p>\u5728dubbo\u63A5\u53E3\u5DE5\u7A0B\u4E2D\u7F16\u5199pojo\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">ObjectId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>collection <span class="token operator">=</span> <span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Video</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3136732836884933873L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ObjectId</span> id<span class="token punctuation">;</span> <span class="token comment">//\u4E3B\u952Eid</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> vid<span class="token punctuation">;</span> <span class="token comment">//\u81EA\u589E\u957Fid</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> text<span class="token punctuation">;</span> <span class="token comment">//\u6587\u5B57</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> picUrl<span class="token punctuation">;</span> <span class="token comment">//\u89C6\u9891\u5C01\u9762\u6587\u4EF6</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> videoUrl<span class="token punctuation">;</span> <span class="token comment">//\u89C6\u9891\u6587\u4EF6</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> created<span class="token punctuation">;</span> <span class="token comment">//\u521B\u5EFA\u65F6\u95F4</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> seeType<span class="token punctuation">;</span> <span class="token comment">// \u8C01\u53EF\u4EE5\u770B\uFF0C1-\u516C\u5F00\uFF0C2-\u79C1\u5BC6\uFF0C3-\u90E8\u5206\u53EF\u89C1\uFF0C4-\u4E0D\u7ED9\u8C01\u770B</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> seeList<span class="token punctuation">;</span> <span class="token comment">//\u90E8\u5206\u53EF\u89C1\u7684\u5217\u8868</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> notSeeList<span class="token punctuation">;</span> <span class="token comment">//\u4E0D\u7ED9\u8C01\u770B\u7684\u5217\u8868</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> longitude<span class="token punctuation">;</span> <span class="token comment">//\u7ECF\u5EA6</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> latitude<span class="token punctuation">;</span> <span class="token comment">//\u7EAC\u5EA6</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> locationName<span class="token punctuation">;</span> <span class="token comment">//\u4F4D\u7F6E\u540D\u79F0</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-2\u3001\u5B9A\u4E49\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_8-1-2\u3001\u5B9A\u4E49\u63A5\u53E3" aria-hidden="true">#</a> 8.1.2\u3001\u5B9A\u4E49\u63A5\u53E3</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">VideoApi</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * \u4FDD\u5B58\u5C0F\u89C6\u9891
     *
     * <span class="token keyword">@param</span> <span class="token parameter">video</span>
     * <span class="token keyword">@return</span> \u4FDD\u5B58\u6210\u529F\u540E\uFF0C\u8FD4\u56DE\u89C6\u9891id
     */</span>
    <span class="token class-name">String</span> <span class="token function">saveVideo</span><span class="token punctuation">(</span><span class="token class-name">Video</span> video<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-3\u3001\u7F16\u5199\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_8-1-3\u3001\u7F16\u5199\u5B9E\u73B0" aria-hidden="true">#</a> 8.1.3\u3001\u7F16\u5199\u5B9E\u73B0</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">Mongo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">IdType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IdService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bson<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">ObjectId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MongoTemplate</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoApiImpl</span> <span class="token keyword">implements</span> <span class="token class-name">VideoApi</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IdService</span> idService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u53D1\u5E03\u5C0F\u89C6\u9891
     *
     * <span class="token keyword">@param</span> <span class="token parameter">video</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saveVideo</span><span class="token punctuation">(</span><span class="token class-name">Video</span> video<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u6821\u9A8C</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isAllNotEmpty</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> video<span class="token punctuation">.</span><span class="token function">getPicUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> video<span class="token punctuation">.</span><span class="token function">getVideoUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//\u8BBE\u7F6Eid</span>
            video<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            video<span class="token punctuation">.</span><span class="token function">setVid</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>idService<span class="token punctuation">.</span><span class="token function">createId</span><span class="token punctuation">(</span><span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">VIDEO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//\u53D1\u5E03\u65F6\u95F4</span>
            video<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//\u4FDD\u5B58\u5230Mongodb\u4E2D</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> video<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5C0F\u89C6\u9891\u53D1\u5E03\u5931\u8D25~ video = &quot;</span> <span class="token operator">+</span> video<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2\u3001app\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_8-2\u3001app\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 8.2\u3001APP\u63A5\u53E3\u670D\u52A1</h3><p>\u63A5\u53E3\u5730\u5740\uFF1Ahttps://mock-java.itheima.net/project/35/interface/api/821</p><p><img src="`+I+`" alt="image-20201222212229360"></p><h4 id="_8-2-1\u3001videocontroller" tabindex="-1"><a class="header-anchor" href="#_8-2-1\u3001videocontroller" aria-hidden="true">#</a> 8.2.1\u3001VideoController</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">VideoService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;smallVideos&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">VideoService</span> videoService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u53D1\u5E03\u5C0F\u89C6\u9891
     *
     * <span class="token keyword">@param</span> <span class="token parameter">picFile</span>
     * <span class="token keyword">@param</span> <span class="token parameter">videoFile</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveVideo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;videoThumbnail&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> picFile<span class="token punctuation">,</span>
                                          <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;videoFile&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> videoFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Boolean</span> bool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoService<span class="token punctuation">.</span><span class="token function">saveVideo</span><span class="token punctuation">(</span>picFile<span class="token punctuation">,</span> videoFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-2-2\u3001videoservice" tabindex="-1"><a class="header-anchor" href="#_8-2-2\u3001videoservice" aria-hidden="true">#</a> 8.2.2\u3001VideoService</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>conn<span class="token punctuation">.</span></span><span class="token class-name">FdfsWebServer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>fdfs<span class="token punctuation">.</span></span><span class="token class-name">StorePath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>tobato<span class="token punctuation">.</span>fastdfs<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">FastFileStorageClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PicUploadService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserThreadLocal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PicUploadResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">VideoApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PicUploadService</span> picUploadService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">protected</span> <span class="token class-name">FastFileStorageClient</span> storageClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FdfsWebServer</span> fdfsWebServer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">VideoApi</span> videoApi<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u53D1\u5E03\u5C0F\u89C6\u9891
     *
     * <span class="token keyword">@param</span> <span class="token parameter">picFile</span>
     * <span class="token keyword">@param</span> <span class="token parameter">videoFile</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">saveVideo</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> picFile<span class="token punctuation">,</span> <span class="token class-name">MultipartFile</span> videoFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Video</span> video <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        video<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        video<span class="token punctuation">.</span><span class="token function">setSeeType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u9ED8\u8BA4\u516C\u5F00</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u4E0A\u4F20\u5C01\u9762\u56FE\u7247</span>
            <span class="token class-name">PicUploadResult</span> picUploadResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>picUploadService<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>picFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            video<span class="token punctuation">.</span><span class="token function">setPicUrl</span><span class="token punctuation">(</span>picUploadResult<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u56FE\u7247\u8DEF\u5F84</span>

            <span class="token comment">//\u4E0A\u4F20\u89C6\u9891</span>
            <span class="token class-name">StorePath</span> storePath <span class="token operator">=</span> storageClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>videoFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    videoFile<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">subAfter</span><span class="token punctuation">(</span>videoFile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//\u8BBE\u7F6E\u89C6\u9891url</span>
            video<span class="token punctuation">.</span><span class="token function">setVideoUrl</span><span class="token punctuation">(</span>fdfsWebServer<span class="token punctuation">.</span><span class="token function">getWebServerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> storePath<span class="token punctuation">.</span><span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> videoId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">saveVideo</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>videoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u53D1\u5E03\u5C0F\u89C6\u9891\u5931\u8D25\uFF01file = &quot;</span> <span class="token operator">+</span> picFile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-3\u3001\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_5-4-3\u3001\u6D4B\u8BD5" aria-hidden="true">#</a> 5.4.3\u3001\u6D4B\u8BD5</h4><p>\u5982\u679C\u4E0A\u4F20\u89C6\u9891\uFF0C\u4F1A\u5BFC\u81F4\u5F02\u5E38\uFF0C\u662F\u56E0\u4E3A\u8BF7\u6C42\u592A\u5927\u7684\u7F18\u6545\uFF1A</p><p><img src="`+S+`" alt="1569075180126"></p><p>\u89E3\u51B3\uFF1Aapplication.properties</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.servlet.multipart.max-file-size</span><span class="token punctuation">=</span><span class="token value attr-value">30MB</span>
<span class="token key attr-name">spring.servlet.multipart.max-request-size</span><span class="token punctuation">=</span><span class="token value attr-value">30MB</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6D4B\u8BD5\uFF1A</p><p><img src="`+q+'" alt="image-20201222214127912"></p><p><img src="'+C+'" alt="image-20201222214313987"></p><p>\u53EF\u4EE5\u770B\u5230\u6570\u636E\u5DF2\u7ECF\u5199\u5165\u5230\u4E86MongoDB\u4E2D\u3002</p><h2 id="_9\u3001\u5C0F\u89C6\u9891\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#_9\u3001\u5C0F\u89C6\u9891\u5217\u8868" aria-hidden="true">#</a> 9\u3001\u5C0F\u89C6\u9891\u5217\u8868</h2><p>\u5C0F\u89C6\u9891\u7684\u5217\u8868\u67E5\u8BE2\u7684\u5B9E\u73B0\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u5982\u679C\u6709\u63A8\u8350\u89C6\u9891\uFF0C\u4F18\u5148\u8FD4\u56DE\u63A8\u8350\u89C6\u9891\uFF0C\u5982\u679C\u4E0D\u591F\u6216\u6CA1\u6709\uFF0C\u6309\u7167\u65F6\u95F4\u5012\u5E8F\u67E5\u8BE2\u89C6\u9891\u8868\u3002</p><p>\u63A8\u8350\u6570\u636E\uFF1A</p><p><img src="'+_+`" alt="image-20201222224514603"></p><h3 id="_9-1\u3001dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_9-1\u3001dubbo\u670D\u52A1" aria-hidden="true">#</a> 9.1\u3001dubbo\u670D\u52A1</h3><h4 id="_9-1-1\u3001\u5B9A\u4E49dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_9-1-1\u3001\u5B9A\u4E49dubbo\u670D\u52A1" aria-hidden="true">#</a> 9.1.1\u3001\u5B9A\u4E49dubbo\u670D\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PageInfo</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">VideoApi</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * \u4FDD\u5B58\u5C0F\u89C6\u9891
     *
     * <span class="token keyword">@param</span> <span class="token parameter">video</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">saveVideo</span><span class="token punctuation">(</span><span class="token class-name">Video</span> video<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u5206\u9875\u67E5\u8BE2\u5C0F\u89C6\u9891\u5217\u8868\uFF0C\u6309\u7167\u65F6\u95F4\u5012\u5E8F\u6392\u5E8F
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-1-2\u3001\u5B9E\u73B0dubbo\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_9-1-2\u3001\u5B9E\u73B0dubbo\u670D\u52A1" aria-hidden="true">#</a> 9.1.2\u3001\u5B9E\u73B0dubbo\u670D\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.dubbo.server.api.VideoApiImpl</span>

    <span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u5C0F\u89C6\u9891\u5217\u8868\uFF0C\u4F18\u5148\u5C55\u73B0\u63A8\u8350\u7684\u89C6\u9891\uFF0C\u5982\u679C\u6CA1\u6709\u63A8\u8350\u7684\u89C6\u9891\u6216\u5DF2\u7ECF\u67E5\u8BE2\u5B8C\u6210\uFF0C\u5C31\u9700\u8981\u67E5\u8BE2\u7CFB\u7EDF\u89C6\u9891\u6570\u636E
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageInfo<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageInfo<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u4ECEredis\u4E2D\u83B7\u53D6\u63A8\u8350\u89C6\u9891\u7684\u6570\u636E</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token string">&quot;QUANZI_VIDEO_RECOMMEND_&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
        <span class="token class-name">String</span> redisData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> vids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> recommendCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u624B\u52A8\u5206\u9875\u67E5\u8BE2\u6570\u636E</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> vidList <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>redisData<span class="token punctuation">,</span> <span class="token char">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u8BA1\u7B97\u5206\u9875</span>
            <span class="token comment">//[0, 10]</span>
            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> startEnd <span class="token operator">=</span> <span class="token class-name">PageUtil</span><span class="token punctuation">.</span><span class="token function">transToStartEnd</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> startIndex <span class="token operator">=</span> startEnd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//\u5F00\u59CB</span>
            <span class="token keyword">int</span> endIndex <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>startEnd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vidList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u7ED3\u675F</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                vids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span>vidList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            recommendCount <span class="token operator">=</span> vidList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>vids<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u6CA1\u6709\u63A8\u8350\u6216\u524D\u9762\u63A8\u8350\u5DF2\u7ECF\u67E5\u8BE2\u5B8C\u6BD5\uFF0C\u67E5\u8BE2\u7CFB\u7EDF\u7684\u89C6\u9891\u6570\u636E</span>

            <span class="token comment">//\u8BA1\u7B97\u524D\u9762\u7684\u63A8\u8350\u89C6\u9891\u9875\u6570</span>
            <span class="token keyword">int</span> totalPage <span class="token operator">=</span> <span class="token class-name">PageUtil</span><span class="token punctuation">.</span><span class="token function">totalPage</span><span class="token punctuation">(</span>recommendCount<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">PageRequest</span> pageRequest <span class="token operator">=</span> <span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>page <span class="token operator">-</span> totalPage <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">Sort</span><span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Order</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> videoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Video</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageInfo<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>videoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pageInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u6839\u636Evid\u67E5\u8BE2\u5BF9\u5E94\u7684\u89C6\u9891\u6570\u636E\u4E86</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;vid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>vids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> videoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">Video</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageInfo<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>videoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pageInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-1-3\u3001\u6D4B\u8BD5\u7528\u4F8B" tabindex="-1"><a class="header-anchor" href="#_9-1-3\u3001\u6D4B\u8BD5\u7528\u4F8B" aria-hidden="true">#</a> 9.1.3\u3001\u6D4B\u8BD5\u7528\u4F8B</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>server<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Video</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestVideoApi</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">VideoApi</span> videoApi<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testQueryVideoList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u8FD4\u56DE\u7684\u63A8\u8350\u7ED3\u679C\u6570\u636E</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u8FD4\u56DE\u5C11\u4E8EpageSize\u6570\u636E\uFF0C\u56E0\u4E3A\u63A8\u8350\u6570\u636E\u4E0D\u591F\u4E86</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u8FD4\u56DE\u7CFB\u7EDF\u6570\u636E</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2\u3001app\u63A5\u53E3\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_9-2\u3001app\u63A5\u53E3\u670D\u52A1" aria-hidden="true">#</a> 9.2\u3001APP\u63A5\u53E3\u670D\u52A1</h3><p>\u670D\u52A1\u5730\u5740\uFF1Ahttps://mock-java.itheima.net/project/35/interface/api/815</p><h4 id="_9-2-1\u3001\u5B9A\u4E49videovo" tabindex="-1"><a class="header-anchor" href="#_9-2-1\u3001\u5B9A\u4E49videovo" aria-hidden="true">#</a> 9.2.1\u3001\u5B9A\u4E49VideoVo</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tanhua<span class="token punctuation">.</span>server<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar<span class="token punctuation">;</span> <span class="token comment">//\u5934\u50CF</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span> <span class="token comment">//\u6635\u79F0</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> cover<span class="token punctuation">;</span> <span class="token comment">//\u5C01\u9762</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> videoUrl<span class="token punctuation">;</span> <span class="token comment">//\u89C6\u9891URL</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> signature<span class="token punctuation">;</span> <span class="token comment">//\u7B7E\u540D</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> likeCount<span class="token punctuation">;</span> <span class="token comment">//\u70B9\u8D5E\u6570\u91CF</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> hasLiked<span class="token punctuation">;</span> <span class="token comment">//\u662F\u5426\u5DF2\u8D5E\uFF081\u662F\uFF0C0\u5426\uFF09</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> hasFocus<span class="token punctuation">;</span> <span class="token comment">//\u662F\u662F\u5426\u5173\u6CE8 \uFF081\u662F\uFF0C0\u5426\uFF09</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> commentCount<span class="token punctuation">;</span> <span class="token comment">//\u8BC4\u8BBA\u6570\u91CF</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-2-2\u3001videocontroller" tabindex="-1"><a class="header-anchor" href="#_9-2-2\u3001videocontroller" aria-hidden="true">#</a> 9.2.2\u3001VideoController</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;smallVideos&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoController</span> <span class="token punctuation">{</span>    
<span class="token doc-comment comment">/**
     * \u67E5\u8BE2\u5C0F\u89C6\u9891\u5217\u8868
     *
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> page<span class="token punctuation">,</span>
                                                     <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;pagesize&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoService<span class="token punctuation">.</span><span class="token function">queryVideoList</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> pageResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>pageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-2-3\u3001videoservice" tabindex="-1"><a class="header-anchor" href="#_9-2-3\u3001videoservice" aria-hidden="true">#</a> 9.2.3\u3001VideoService</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//com.tanhua.server.service.VideoService</span>

	<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">queryVideoList</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPagesize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>videoApi<span class="token punctuation">.</span><span class="token function">queryVideoList</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Video</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u67E5\u8BE2\u7528\u6237\u4FE1\u606F</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userInfoService<span class="token punctuation">.</span><span class="token function">queryUserInfoByUserIdList</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VideoVo</span><span class="token punctuation">&gt;</span></span> videoVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Video</span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">VideoVo</span> videoVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VideoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            videoVo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setCover</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getPicUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setVideoUrl</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getVideoUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setSignature</span><span class="token punctuation">(</span><span class="token string">&quot;\u6211\u5C31\u662F\u6211~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u7B7E\u540D</span>

            videoVo<span class="token punctuation">.</span><span class="token function">setCommentCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u8BC4\u8BBA\u6570</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setHasFocus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u662F\u5426\u5173\u6CE8</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setHasLiked</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//TODO \u662F\u5426\u70B9\u8D5E\uFF081\u662F\uFF0C0\u5426\uFF09</span>
            videoVo<span class="token punctuation">.</span><span class="token function">setLikeCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//TODO \u70B9\u8D5E\u6570</span>

            <span class="token comment">//\u586B\u5145\u7528\u6237\u4FE1\u606F</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span> userInfo <span class="token operator">:</span> userInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>videoVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    videoVo<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    videoVo<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            videoVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>videoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>videoVoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-2-5\u3001\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#_9-2-5\u3001\u6D4B\u8BD5" aria-hidden="true">#</a> 9.2.5\u3001\u6D4B\u8BD5</h4><p><img src="`+L+'" alt="image-20201222234918988"></p><p><img src="'+j+'" alt="image-20201222234936528"></p><p>\u53EF\u4EE5\u770B\u5230\u5DF2\u7ECF\u67E5\u8BE2\u5230\u6570\u636E\u3002\u4E0B\u9762\u4F7F\u7528\u624B\u673A\u8FDB\u884C\u6D4B\u8BD5\uFF1A</p><p><img src="'+R+'" alt="image-20201222235041124"></p>',190),x=[T];function E(P,U){return s(),a("div",null,x)}const O=n(V,[["render",E],["__file","day05-\u5708\u5B50\u3001\u5C0F\u89C6\u9891\u529F\u80FD\u5B9E\u73B0.html.vue"]]);export{O as default};
